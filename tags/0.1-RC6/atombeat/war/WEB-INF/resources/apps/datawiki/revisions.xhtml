<!--
    Copyright (C) 2010 University of Oxford

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:xforms="http://www.w3.org/2002/xforms"
      xmlns:xs="http://www.w3.org/2001/XMLSchema"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
      xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
      xmlns:atom="http://www.w3.org/2005/Atom"
      xmlns:ar="http://purl.org/atompub/revision/1.0">
      
    <head>
        <title>AtomBeat DataWiki - <xforms:output ref="instance('ins-entry')/atom:title"/></title>
        
        <xforms:model id="mod-main">

            <xforms:action ev:event="xforms-model-construct-done">
            	<xforms:setvalue ref="instance('ins-state')/revision" value="xxforms:get-request-parameter('rev')"/>
            </xforms:action>

			<xforms:submission 
				id="sub-get-entry"
				resource="{xxforms:get-request-parameter('entry')}"
				method="get"
				replace="instance"
				instance="ins-entry">
				<xforms:send ev:event="xforms-submit-done" submission="sub-get-history-feed"/>
			</xforms:submission>        

			<xforms:send ev:event="xforms-model-construct-done" submission="sub-get-entry"/>
			
            <xforms:instance id="ins-entry">
            	<atom:entry/>
            </xforms:instance>
            
            <xforms:submission
            	id="sub-get-history-feed"
            	resource="{instance('ins-entry')/atom:link[@rel='history']/@href}"
            	method="get"
            	replace="instance"
            	instance="ins-history-feed">
            	<xforms:setvalue ev:event="xforms-submit-done" ref="instance('ins-state')/revision" if="empty(instance('ins-state')/revision/text())" value="max(instance('ins-history-feed')/atom:entry/ar:revision/@number)"/>
            	<xforms:send ev:event="xforms-submit-done" submission="sub-get-revision"/>
           	</xforms:submission>
           	
           	<xforms:instance id="ins-history-feed">
           		<atom:feed/>
           	</xforms:instance>
           	
           	<xforms:bind nodeset="instance('ins-history-feed')">
  				<xforms:bind nodeset="atom:entry">
  					<xforms:bind nodeset="ar:revision">
  						<xforms:bind nodeset="@number" type="xs:integer"/>
  						<xforms:bind nodeset="@when" type="xs:date"/>
  					</xforms:bind>
  				</xforms:bind>         	
           	</xforms:bind>
            
            <xforms:submission
            	id="sub-get-revision"
            	resource="{instance('ins-history-feed')/atom:entry[ar:revision/@number=instance('ins-state')/revision]/atom:link[@rel='this-revision']/@href}"
            	method="get"
            	replace="instance"
            	instance="ins-revision">
           		<xforms:setvalue ev:event="xforms-submit-done" if="count(instance('ins-revision')/atom:content/table/tbody/tr) gt 10" ref="instance('ins-state')/view" value="'10'"/>
           		<xforms:setvalue ev:event="xforms-submit-done" if="count(instance('ins-revision')/atom:content/table/tbody/tr) le 10" ref="instance('ins-state')/view" value="'all'"/>
           	</xforms:submission>
            
            <xforms:instance id="ins-revision">
            	<atom:entry/>
            </xforms:instance>
            
            <xforms:bind nodeset="instance('ins-revision')/atom:content/table/tbody/tr">
            
            	<xforms:bind nodeset="td">
            	
					<!-- type bindings - needed to ensure datatable sorts properly -->
    	       		<xforms:bind nodeset="for $p in (position()) return .[instance('ins-revision')/atom:content/table/thead/tr/th[$p]/datatype = 'integer']" type="xforms:integer"/>
    	       		<xforms:bind nodeset="for $p in (position()) return .[instance('ins-revision')/atom:content/table/thead/tr/th[$p]/datatype = 'boolean']" type="xforms:boolean"/>
    	       		<xforms:bind nodeset="for $p in (position()) return .[instance('ins-revision')/atom:content/table/thead/tr/th[$p]/datatype = 'date']" type="xforms:date"/>
    	       		<xforms:bind nodeset="for $p in (position()) return .[instance('ins-revision')/atom:content/table/thead/tr/th[$p]/datatype = 'time']" type="xforms:time"/>
    	       		<xforms:bind nodeset="for $p in (position()) return .[instance('ins-revision')/atom:content/table/thead/tr/th[$p]/datatype = 'decimal']" type="xforms:decimal"/>

	           	</xforms:bind>
 
            </xforms:bind>
            
            <xforms:instance id="ins-state">
            	<state xmlns="">
            		<revision/>
            		<revision-count/>
            		<next/>
            		<previous/>
            		<view/>
            	</state>
            </xforms:instance>
            
            <xforms:bind nodeset="instance('ins-state')">
            	<xforms:bind nodeset="revision-count" calculate="max(instance('ins-history-feed')/atom:entry/ar:revision/@number)"/>
            	<xforms:bind nodeset="next" calculate="if ( exists(../revision/text()) and exists(../revision-count/text()) and xs:integer(../revision) lt xs:integer(../revision-count) ) then xs:integer(../revision) + 1 else ()"/>
            	<xforms:bind nodeset="previous" calculate="if ( exists(../revision/text()) and xs:integer(../revision) gt 1 ) then xs:integer(../revision) - 1 else ()"/>
            </xforms:bind>
            
        </xforms:model>
        
        <link rel="stylesheet" type="text/css" href="/ops/yui/tabview/assets/skins/sam/tabview.css"></link>
        <style type="text/css">
.yui-skin-sam tr.yui-dt-selected td, .yui-skin-sam tr.yui-dt-selected td.yui-dt-asc, .yui-skin-sam tr.yui-dt-selected td.yui-dt-desc {
	background-color:inherit;
	color:inherit;
}

.yui-skin-sam .yui-dt-scrollable .yui-dt-hd {
	border-top: none;
	border-bottom: none;
	border-left: none;
	border-right: none;
}

.yui-skin-sam .yui-dt-scrollable table {
	border: 1px solid #7F7F7F;
}

.revision-meta {
	background-color: white;
	border: 1px solid #7F7F7F;
	padding: 0 .5em .5em .5em;
}
        </style>

    </head>
    
    <body>
    
    	<xforms:group ref="instance('ins-entry')">
	
			<p><a href="./">DataWiki</a></p>
			
			<h1><xforms:output ref="atom:title"/></h1>  
			
			<p></p>  	
    	
    		<div class="yui-navset yui-navset-top">
    			<ul class="yui-nav">
    				<li>
    					<a href="view?entry={atom:link[@rel='edit']/@href}">
	    					<em>View</em>
    					</a>
    				</li>
    				<li>
    					<a href="edit?entry={atom:link[@rel='edit']/@href}">
	    					<em>Edit</em>
    					</a>
   					</li>
    				<li>
    					<a href="schema?entry={atom:link[@rel='edit']/@href}">
	    					<em>Schema</em>
    					</a>
   					</li>
    				<li>
    					<a href="history?entry={atom:link[@rel='edit']/@href}">
	    					<em>History</em>
    					</a>
   					</li>
    				<li class="selected">
    					<a href="revisions?entry={atom:link[@rel='edit']/@href}">
	    					<em>Revisions</em>
    					</a>
   					</li>
    			</ul>
    			
    			<div class="yui-content">
    			
    				<div class="revision-meta">
    					
    					<p><strong>
    						Showing revision <xforms:output value="instance('ins-state')/revision"/> 
    						of <xforms:output value="max(instance('ins-history-feed')/atom:entry/ar:revision/@number)"/>
    						by <xforms:output value="concat( instance('ins-revision')/ar:comment/atom:author/atom:name , ' ' , instance('ins-revision')/ar:comment/atom:author/atom:email)"/>
    						on <xforms:output ref="instance('ins-revision')/ar:revision/@when"  xxforms:format="format-dateTime(., '[D01]/[M01]/[Y] at [h01]:[m01]:[s01]')"/>.
						</strong></p>
						
						<a href="revisions?entry={instance('ins-entry')/atom:link[@rel='edit']/@href}&amp;rev=1">&lt;&lt; first rev</a>
						<a href="revisions?entry={instance('ins-entry')/atom:link[@rel='edit']/@href}&amp;rev={instance('ins-state')/previous}">&lt; prev rev</a>
						<a href="revisions?entry={instance('ins-entry')/atom:link[@rel='edit']/@href}&amp;rev={instance('ins-state')/next}">next rev ></a>
						<a href="revisions?entry={instance('ins-entry')/atom:link[@rel='edit']/@href}&amp;rev={instance('ins-state')/revision-count}">latest rev >></a>
    					
    				</div>
    			
    				<p>
<!--    					Showing <xforms:output value="instance('ins-state')/view"/> of <xforms:output value="count(instance('ins-revision')/atom:content/table/tbody/tr)"/> rows.-->
	   					<xforms:group ref="instance('ins-revision')[count(atom:content/table/tbody/tr) gt 10]">
	    					Rows per page:
	    					<xforms:trigger appearance="minimal">
	    						<xforms:label>10</xforms:label>
				           		<xforms:setvalue ev:event="DOMActivate" ref="instance('ins-state')/view" value="'10'"/>
	    					</xforms:trigger> |
	    					<xforms:group ref="instance('ins-revision')[count(atom:content/table/tbody/tr) gt 50]">
		    					<xforms:trigger appearance="minimal">
		    						<xforms:label>50</xforms:label>
					           		<xforms:setvalue ev:event="DOMActivate" ref="instance('ins-state')/view" value="'50'"/>
		    					</xforms:trigger> |
	    					</xforms:group>
	    					<xforms:group ref="instance('ins-revision')[count(atom:content/table/tbody/tr) gt 100]">
		    					<xforms:trigger appearance="minimal">
		    						<xforms:label>100</xforms:label>
					           		<xforms:setvalue ev:event="DOMActivate" ref="instance('ins-state')/view" value="'100'"/>
		    					</xforms:trigger> |
	    					</xforms:group>
	    					<xforms:trigger appearance="minimal">
	    						<xforms:label>show all</xforms:label>
				           		<xforms:setvalue ev:event="DOMActivate" ref="instance('ins-state')/view" value="'all'"/>
	    					</xforms:trigger>
	   					</xforms:group>
    				</p>
    			
					<xforms:group ref="instance('ins-state')[view='10']">

						<xforms:group ref="instance('ins-revision')/atom:content/table">
						
				   			<fr:datatable 
				   				paginated="true" 
				   				sortAndPaginationMode="internal" 
				   				rowsPerPage="10"
				   				maxNbPagesToDisplay="9">
				   			
				   				<thead>
				   					<tr>
				   						<xforms:repeat nodeset="thead/tr/th">
											<th fr:sortable="true" fr:resizeable="true">
												<xforms:output value="label"/>
											</th>	    						
				   						</xforms:repeat>
				   					</tr>
				   				</thead>
				   				
				   				<tbody>
				   					<xforms:repeat nodeset="tbody/tr">
				   						<tr>
				    						<xforms:repeat nodeset="td">
												<td>
													<xforms:output value="."/>
												</td>	    						
				    						</xforms:repeat>
				   						</tr>
				   					</xforms:repeat>
				   				</tbody>
				   				
				   			</fr:datatable>
				   			
						</xforms:group>
						
					</xforms:group>
    					
					<xforms:group ref="instance('ins-state')[view='50']">

						<xforms:group ref="instance('ins-revision')/atom:content/table">

				   			<fr:datatable 
				   				paginated="true" 
				   				sortAndPaginationMode="internal" 
				   				rowsPerPage="50"
				   				maxNbPagesToDisplay="9">
				   			
				   				<thead>
				   					<tr>
				   						<xforms:repeat nodeset="thead/tr/th">
											<th fr:sortable="true" fr:resizeable="true">
												<xforms:output value="label"/>
											</th>	    						
				   						</xforms:repeat>
				   					</tr>
				   				</thead>
				   				
				   				<tbody>
				   					<xforms:repeat nodeset="tbody/tr">
				   						<tr>
				    						<xforms:repeat nodeset="td">
												<td>
													<xforms:output value="."/>
												</td>	    						
				    						</xforms:repeat>
				   						</tr>
				   					</xforms:repeat>
				   				</tbody>
				   				
				   			</fr:datatable>
						
						</xforms:group>
						
					</xforms:group>
					
					<xforms:group ref="instance('ins-state')[view='100']">

						<xforms:group ref="instance('ins-revision')/atom:content/table">
   					
				   			<fr:datatable 
				   				paginated="true" 
				   				sortAndPaginationMode="internal" 
				   				rowsPerPage="100"
				   				maxNbPagesToDisplay="9">
				   			
				   				<thead>
				   					<tr>
				   						<xforms:repeat nodeset="thead/tr/th">
											<th fr:sortable="true" fr:resizeable="true">
												<xforms:output value="label"/>
											</th>	    						
				   						</xforms:repeat>
				   					</tr>
				   				</thead>
				   				
				   				<tbody>
				   					<xforms:repeat nodeset="tbody/tr">
				   						<tr>
				    						<xforms:repeat nodeset="td">
												<td>
													<xforms:output value="."/>
												</td>	    						
				    						</xforms:repeat>
				   						</tr>
				   					</xforms:repeat>
				   				</tbody>
				   				
				   			</fr:datatable>
				
						</xforms:group>
						
					</xforms:group>
					
					<xforms:group ref="instance('ins-state')[view='all']">

						<xforms:group ref="instance('ins-revision')/atom:content/table">
    					
				   			<fr:datatable 
				   				paginated="false">
				   			
				   				<thead>
				   					<tr>
				   						<xforms:repeat nodeset="thead/tr/th">
											<th fr:sortable="true" fr:resizeable="true">
												<xforms:output value="label"/>
											</th>	    						
				   						</xforms:repeat>
				   					</tr>
				   				</thead>
				   				
				   				<tbody>
				   					<xforms:repeat nodeset="tbody/tr">
				   						<tr>
				    						<xforms:repeat nodeset="td">
												<td>
													<xforms:output value="."/>
												</td>	    						
				    						</xforms:repeat>
				   						</tr>
				   					</xforms:repeat>
				   				</tbody>
				   				
				   			</fr:datatable>
									
    					</xforms:group>
    					
    				</xforms:group>

    			</div>
    			
   			</div>
    			
    	</xforms:group>
 			
    	
    </body>
</html>
