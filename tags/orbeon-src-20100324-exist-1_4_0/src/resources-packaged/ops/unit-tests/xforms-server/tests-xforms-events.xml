<?xml version="1.0" encoding="UTF-8"?>
<!--
  Copyright (C) 2010 Orbeon, Inc.

  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<group description="XForms Server" xmlns:p="http://www.orbeon.com/oxf/pipeline"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xhtml="http://www.w3.org/1999/xhtml"
    xmlns:xu="http://www.xmldb.org/xupdate"
    xmlns:oxf="http://www.orbeon.com/oxf/processors"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
    xmlns:xforms="http://www.w3.org/2002/xforms"
    xmlns:xf="http://www.w3.org/2002/xforms"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:xbl="http://www.w3.org/ns/xbl"
    xmlns:fr="http://orbeon.org/oxf/xml/form-runner">

    <test description="ev:observer and ev:target" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="xforms-server/wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="my-model">
                                    <xforms:instance id="my-instance">
                                        <instance>initial</instance>
                                    </xforms:instance>

                                    <xforms:action ev:observer="my-group" ev:target="my-input" ev:event="DOMFocusIn">
                                        <xforms:setvalue ref=".">new</xforms:setvalue>
                                    </xforms:action>
                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xforms:group id="my-group">
                                    <xforms:input id="my-input" ref=".">
                                        <xforms:label>My Data</xforms:label>
                                    </xforms:input>

                                    <xforms:action ev:observer="my-model" ev:event="xforms-ready">
                                        <xforms:dispatch name="DOMFocusIn" target="my-input"/>
                                    </xforms:action>

                                </xforms:group>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="my-instance" model-id="my-model">
                                <instance>new</instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-input" label="My Data">new</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="ev:event='#all' ev:propagate='stop'" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="xforms-server/wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="model">
                                    <xforms:instance id="instance">
                                        <value xmlns=""/>
                                    </xforms:instance>

                                    <!-- Cause value change -->
                                    <xforms:setvalue ev:event="xforms-ready" ref=".">New value</xforms:setvalue>

                                    <!-- TEST: Events to gather -->
                                    <xforms:instance id="events">
                                        <events/>
                                    </xforms:instance>
                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xforms:group id="my-group-1">
                                    <!-- Record all events -->
                                    <xforms:insert ev:event="#all"
                                                   context="instance('events')" nodeset="*"
                                                   origin="xxforms:element('event',
                                                            (xxforms:attribute('type', xxforms:event('xxforms:type')),
                                                             xxforms:attribute('target', xxforms:event('xxforms:targetid')),
                                                             xxforms:attribute('indexes', string-join(xxforms:event('xxforms:repeat-indexes'), ' '))))"/>

                                    <xforms:input id="my-input-1" ref="."/>

                                    <xforms:group id="my-group-2">
                                        <!-- Filter all events -->
                                        <xforms:action ev:event="#all" ev:propagate="stop"/>
                                        <xforms:input id="my-input-2" ref="."/>
                                    </xforms:group>
                                </xforms:group>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <value>New value</value>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-enabled" target="my-group-1" indexes=""/>
                                    <event type="xforms-enabled" target="my-input-1" indexes=""/>
                                    <event type="xforms-value-changed" target="my-input-1" indexes=""/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-input-1">New value</xxf:control>
                        <xxf:control id="my-input-2">New value</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="DnD events" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="xforms-server/wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html xmlns:fr="http://orbeon.org/oxf/xml/form-runner">
                            <xhtml:head>
                                <xforms:model id="model">
                                    <xforms:instance id="instance1">
                                        <instance>
                                            <row>row1</row>
                                            <row>row2</row>
                                            <row>row3</row>
                                        </instance>
                                    </xforms:instance>
                                    <xforms:instance id="instance2">
                                        <instance>
                                            <row>row1</row>
                                            <row>row2</row>
                                            <row>row3</row>
                                        </instance>
                                    </xforms:instance>
                                    <xforms:instance id="instance3">
                                        <instance>
                                            <row>row1</row>
                                            <row>row2</row>
                                            <row>row3</row>
                                        </instance>
                                    </xforms:instance>
                                    <xforms:instance id="instance4">
                                        <instance>
                                            <row>row1</row>
                                            <row>row2</row>
                                            <row>row3</row>
                                        </instance>
                                    </xforms:instance>
                                    <xforms:instance id="instance5">
                                        <instance>
                                            <row>row1</row>
                                            <row>row2</row>
                                            <row>row3</row>
                                        </instance>
                                    </xforms:instance>
                                    <xforms:instance id="instance6">
                                        <instance>
                                            <row>row1</row>
                                            <row>row2</row>
                                            <row>row3</row>
                                        </instance>
                                    </xforms:instance>

                                    <xforms:action ev:event="xforms-ready">
                                        <xforms:dispatch target="repeat1" name="xxforms-dnd">
                                            <xxforms:context name="dnd-start" select="1"/>
                                            <xxforms:context name="dnd-end" select="2"/>
                                        </xforms:dispatch>
                                        <xforms:dispatch target="repeat2" name="xxforms-dnd">
                                            <xxforms:context name="dnd-start" select="1"/>
                                            <xxforms:context name="dnd-end" select="3"/>
                                        </xforms:dispatch>
                                        <xforms:dispatch target="repeat3" name="xxforms-dnd">
                                            <xxforms:context name="dnd-start" select="2"/>
                                            <xxforms:context name="dnd-end" select="1"/>
                                        </xforms:dispatch>
                                        <xforms:dispatch target="repeat4" name="xxforms-dnd">
                                            <xxforms:context name="dnd-start" select="2"/>
                                            <xxforms:context name="dnd-end" select="3"/>
                                        </xforms:dispatch>
                                        <xforms:dispatch target="repeat5" name="xxforms-dnd">
                                            <xxforms:context name="dnd-start" select="3"/>
                                            <xxforms:context name="dnd-end" select="1"/>
                                        </xforms:dispatch>
                                        <xforms:dispatch target="repeat6" name="xxforms-dnd">
                                            <xxforms:context name="dnd-start" select="3"/>
                                            <xxforms:context name="dnd-end" select="2"/>
                                        </xforms:dispatch>
                                    </xforms:action>

                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>

                                <xforms:repeat id="repeat1" nodeset="instance('instance1')/row" xxforms:dnd="true">
                                    <xforms:output id="output1" value="."/>
                                </xforms:repeat>
                                <xforms:repeat id="repeat2" nodeset="instance('instance2')/row" xxforms:dnd="true">
                                    <xforms:output id="output2" value="."/>
                                </xforms:repeat>
                                <xforms:repeat id="repeat3" nodeset="instance('instance3')/row" xxforms:dnd="true">
                                    <xforms:output id="output3" value="."/>
                                </xforms:repeat>
                                <xforms:repeat id="repeat4" nodeset="instance('instance4')/row" xxforms:dnd="true">
                                    <xforms:output id="output4" value="."/>
                                </xforms:repeat>
                                <xforms:repeat id="repeat5" nodeset="instance('instance5')/row" xxforms:dnd="true">
                                    <xforms:output id="output5" value="."/>
                                </xforms:repeat>
                                <xforms:repeat id="repeat6" nodeset="instance('instance6')/row" xxforms:dnd="true">
                                    <xforms:output id="output6" value="."/>
                                </xforms:repeat>

                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance1" model-id="model">
                                <instance>
                                    <row>row2</row>
                                    <row>row1</row>
                                    <row>row3</row>
                                </instance>
                            </instance>
                            <instance id="instance2" model-id="model">
                                <instance>
                                    <row>row2</row>
                                    <row>row3</row>
                                    <row>row1</row>
                                </instance>
                            </instance>
                            <instance id="instance3" model-id="model">
                                <instance>
                                    <row>row2</row>
                                    <row>row1</row>
                                    <row>row3</row>
                                </instance>
                            </instance>
                            <instance id="instance4" model-id="model">
                                <instance>
                                    <row>row1</row>
                                    <row>row3</row>
                                    <row>row2</row>
                                </instance>
                            </instance>
                            <instance id="instance5" model-id="model">
                                <instance>
                                    <row>row3</row>
                                    <row>row1</row>
                                    <row>row2</row>
                                </instance>
                            </instance>
                            <instance id="instance6" model-id="model">
                                <instance>
                                    <row>row1</row>
                                    <row>row3</row>
                                    <row>row2</row>
                                </instance>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="repeat1" index="2"/>
                            <control effective-id="repeat2" index="3"/>
                            <control effective-id="repeat3" index="1"/>
                            <control effective-id="repeat4" index="3"/>
                            <control effective-id="repeat5" index="1"/>
                            <control effective-id="repeat6" index="2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="output1·1">row2</xxf:control>
                        <xxf:control id="output1·2">row1</xxf:control>
                        <xxf:control id="output1·3">row3</xxf:control>
                        <xxf:control id="output2·1">row2</xxf:control>
                        <xxf:control id="output2·2">row3</xxf:control>
                        <xxf:control id="output2·3">row1</xxf:control>
                        <xxf:control id="output3·1">row2</xxf:control>
                        <xxf:control id="output3·2">row1</xxf:control>
                        <xxf:control id="output3·3">row3</xxf:control>
                        <xxf:control id="output4·1">row1</xxf:control>
                        <xxf:control id="output4·2">row3</xxf:control>
                        <xxf:control id="output4·3">row2</xxf:control>
                        <xxf:control id="output5·1">row3</xxf:control>
                        <xxf:control id="output5·2">row1</xxf:control>
                        <xxf:control id="output5·3">row2</xxf:control>
                        <xxf:control id="output6·1">row1</xxf:control>
                        <xxf:control id="output6·2">row3</xxf:control>
                        <xxf:control id="output6·3">row2</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Controls nested within non-relevant markup do not get xforms-enabled" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xforms="http://www.w3.org/2002/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="xforms-server/wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model xxforms:state-handling="client" id="model">
                                    <xforms:instance id="instance">
                                        <instance>
                                            <relevant/>
                                            <non-relevant>
                                                <nested-non-relevant/>
                                            </non-relevant>
                                        </instance>
                                    </xforms:instance>
                                    <xforms:bind nodeset="non-relevant" relevant="false()"/>
                                    <!-- Still, that node will be non-relevant because an ancestor is non-relevant -->
                                    <xforms:bind nodeset="non-relevant/nested-non-relevant" relevant="true()"/>

                                    <!-- TEST: Events to gather -->
                                    <xforms:instance id="events">
                                        <events/>
                                    </xforms:instance>
                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xforms:group id="events-group">
                                    <xforms:insert ev:event="xforms-enabled"
                                                   context="instance('events')" nodeset="*"
                                                   origin="xxforms:element('event',
                                                            (xxforms:attribute('type', event('xxforms:type')),
                                                             xxforms:attribute('target', event('xxforms:targetid'))
                                                             ))"/>

                                    <!-- Everything relevant -->
                                    <xforms:group id="group-1-1">
                                        <xforms:output id="output-1-1" value="''"/>
                                        <xforms:output id="output-1-2" ref="relevant"/>
                                        <xforms:group id="group-1-2">
                                            <xforms:output id="output-1-3" value="''"/>
                                            <xforms:output id="output-1-4" ref="relevant"/>
                                        </xforms:group>
                                    </xforms:group>

                                    <!-- Nothing relevant -->
                                    <xforms:group id="group-2-1" ref="()">
                                        <xforms:output id="output-2-1" value="''"/>
                                        <xforms:output id="output-2-2" ref="relevant"/>
                                        <xforms:group id="group-2-2">
                                            <xforms:output id="output-2-3" value="''"/>
                                            <xforms:output id="output-2-4" ref="relevant"/>
                                        </xforms:group>
                                    </xforms:group>

                                    <!-- Nested group non-relevant by binding to non-relevant node -->
                                    <xforms:group id="group-3-1">
                                        <xforms:output id="output-3-1" value="''"/>
                                        <xforms:output id="output-3-2" ref="relevant"/>
                                        <xforms:group id="group-3-2" ref="non-relevant/nested-non-relevant">
                                            <xforms:output id="output-3-3" value="''"/>
                                            <xforms:output id="output-3-4" ref="../../relevant"/><!-- this won't change anything -->
                                        </xforms:group>
                                    </xforms:group>

                                    <!-- Nested group non-relevant by binding to no node -->
                                    <xforms:group id="group-4-1">
                                        <xforms:output id="output-4-1" value="''"/>
                                        <xforms:output id="output-4-2" ref="relevant"/>
                                        <xforms:group id="group-4-2" ref="()">
                                            <xforms:output id="output-4-3" value="''"/>
                                            <xforms:output id="output-4-4" ref="../relevant"/><!-- this won't change anything -->
                                        </xforms:group>
                                    </xforms:group>

                                </xforms:group>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <relevant/>
                                    <non-relevant>
                                        <nested-non-relevant/>
                                    </non-relevant>
                                </instance>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-enabled" target="events-group"/>
                                    <event type="xforms-enabled" target="group-1-1"/>
                                    <event type="xforms-enabled" target="output-1-1"/>
                                    <event type="xforms-enabled" target="output-1-2"/>
                                    <event type="xforms-enabled" target="group-1-2"/>
                                    <event type="xforms-enabled" target="output-1-3"/>
                                    <event type="xforms-enabled" target="output-1-4"/>
                                    <event type="xforms-enabled" target="group-3-1"/>
                                    <event type="xforms-enabled" target="output-3-1"/>
                                    <event type="xforms-enabled" target="output-3-2"/>
                                    <event type="xforms-enabled" target="group-4-1"/>
                                    <event type="xforms-enabled" target="output-4-1"/>
                                    <event type="xforms-enabled" target="output-4-2"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="group-2-1" relevant="false"/>
                        <xxf:control id="output-2-1" relevant="false"/>
                        <xxf:control id="output-2-2" relevant="false"/>
                        <xxf:control id="group-2-2" relevant="false"/>
                        <xxf:control id="output-2-3" relevant="false"/>
                        <xxf:control id="output-2-4" relevant="false"/>
                        <xxf:control id="group-3-2" relevant="false"/>
                        <xxf:control id="output-3-3" relevant="false"/>
                        <xxf:control id="output-3-4" relevant="false"/>
                        <xxf:control id="group-4-2" relevant="false"/>
                        <xxf:control id="output-4-3" relevant="false"/>
                        <xxf:control id="output-4-4" relevant="false"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Value change event on group" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xforms="http://www.w3.org/2002/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="xforms-server/wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model xxforms:state-handling="client" id="model">
                                    <xforms:instance id="instance">
                                        <instance>
                                            <value/>
                                            <constant>constant</constant>
                                        </instance>
                                    </xforms:instance>

                                    <xforms:setvalue ev:event="xforms-ready" ref="value">new</xforms:setvalue>

                                    <!-- TEST: Events to gather -->
                                    <xforms:instance id="events">
                                        <events/>
                                    </xforms:instance>
                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xforms:group id="events-group">
                                    <xforms:insert ev:event="xforms-value-changed"
                                                   context="instance('events')" nodeset="*"
                                                   origin="xxforms:element('event',
                                                            (xxforms:attribute('type', event('xxforms:type')),
                                                             xxforms:attribute('target', event('xxforms:targetid'))
                                                             ))"/>

                                    <!-- Must not get event -->
                                    <xforms:group id="group-1"/>
                                    <!-- Must get event -->
                                    <xforms:group id="group-2" ref="value"/>
                                    <!-- Must not get event -->
                                    <xforms:group id="group-3" ref="constant"/>

                                </xforms:group>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <value>new</value>
                                    <constant>constant</constant>
                                </instance>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-value-changed" target="group-2"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Value change event on switch" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xforms="http://www.w3.org/2002/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="xforms-server/wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model xxforms:state-handling="client" id="model">
                                    <xforms:instance id="instance">
                                        <instance>
                                            <value/>
                                            <constant>constant</constant>
                                        </instance>
                                    </xforms:instance>

                                    <xforms:setvalue ev:event="xforms-ready" ref="value">new</xforms:setvalue>

                                    <!-- TEST: Events to gather -->
                                    <xforms:instance id="events">
                                        <events/>
                                    </xforms:instance>
                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xforms:group id="events-group">
                                    <xforms:insert ev:event="xforms-value-changed"
                                                   context="instance('events')" nodeset="*"
                                                   origin="xxforms:element('event',
                                                            (xxforms:attribute('type', event('xxforms:type')),
                                                             xxforms:attribute('target', event('xxforms:targetid'))
                                                             ))"/>

                                    <!-- Must not get event -->
                                    <xforms:switch id="switch-1">
                                        <xforms:case id="case-1">Case 1</xforms:case>
                                    </xforms:switch>
                                    <!-- Must get event -->
                                    <xforms:switch id="switch-2" ref="value">
                                        <xforms:case id="case-2">Case 2</xforms:case>
                                    </xforms:switch>
                                    <!-- Must not get event -->
                                    <xforms:switch id="switch-3" ref="constant">
                                        <xforms:case id="case-3">Case 3</xforms:case>
                                    </xforms:switch>

                                </xforms:group>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <value>new</value>
                                    <constant>constant</constant>
                                </instance>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-value-changed" target="switch-2"/>
                                </events>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="switch-1" case-id="case-1"/>
                            <control effective-id="switch-2" case-id="case-2"/>
                            <control effective-id="switch-3" case-id="case-3"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:div id="case-1" visibility="visible"/>
                        <xxf:div id="case-2" visibility="visible"/>
                        <xxf:div id="case-3" visibility="visible"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Value change event on output" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xforms="http://www.w3.org/2002/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="xforms-server/wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model xxforms:state-handling="client" id="model">
                                    <xforms:instance id="instance">
                                        <instance>
                                            <value/>
                                            <constant>constant</constant>
                                        </instance>
                                    </xforms:instance>

                                    <xforms:setvalue ev:event="xforms-ready" ref="value">new</xforms:setvalue>

                                    <!-- TEST: Events to gather -->
                                    <xforms:instance id="events">
                                        <events/>
                                    </xforms:instance>
                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xforms:group id="events-group">
                                    <xforms:insert ev:event="xforms-value-changed"
                                                   context="instance('events')" nodeset="*"
                                                   origin="xxforms:element('event',
                                                            (xxforms:attribute('type', event('xxforms:type')),
                                                             xxforms:attribute('target', event('xxforms:targetid'))
                                                             ))"/>

                                    <xforms:output id="output-1" value="value"/>
                                    <xforms:output id="output-2" ref="value"/>
                                    <xforms:output id="output-3" value="constant"/>
                                    <xforms:output id="output-4" ref="constant"/>

                                </xforms:group>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <value>new</value>
                                    <constant>constant</constant>
                                </instance>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-value-changed" target="output-1"/>
                                    <event type="xforms-value-changed" target="output-2"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="output-1">new</xxf:control>
                        <xxf:control id="output-2">new</xxf:control>
                        <xxf:control id="output-3">constant</xxf:control>
                        <xxf:control id="output-4">constant</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Event listener on xforms:repeat" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="xforms-server/wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="model">
                                    <xforms:instance xmlns="" id="instance">
                                        <values>
                                            <value>1</value>
                                            <value>2</value>
                                            <value>3</value>
                                            <value>4</value>
                                        </values>
                                    </xforms:instance>
                                    <xforms:instance xmlns="" id="changes">
                                        <changes/>
                                    </xforms:instance>

                                    <xforms:action ev:event="xforms-ready">
                                        <!-- Insert a node: this will immediately cause a repeat nodeset change -->
                                        <xforms:insert nodeset="value" origin="xxforms:element('value', count(../value) + 1)"/>
                                    </xforms:action>

                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xforms:repeat nodeset="value" id="my-repeat">
                                    <xforms:setvalue ev:event="xxforms-nodeset-changed" ref="instance('changes')" value="count(context()/../value)"/>
                                </xforms:repeat>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <values>
                                    <value>1</value>
                                    <value>2</value>
                                    <value>3</value>
                                    <value>4</value>
                                    <value>5</value>
                                </values>
                            </instance>
                            <instance id="changes" model-id="model">
                                <changes>5</changes>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-repeat" index="5"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <!-- NOTE: This test is disabled because as of 2009-10 we can't run the setvalue within an empty context. -->
    <test description="Event listener on xforms:repeat when node-set becomes empty" name="oxf:pipeline" exclude="true">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="xforms-server/wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="model">
                                    <xforms:instance xmlns="" id="instance">
                                        <values>
                                            <dummy/>
                                            <value>1</value>
                                            <value>2</value>
                                            <value>3</value>
                                            <value>4</value>
                                        </values>
                                    </xforms:instance>
                                    <xforms:instance xmlns="" id="changes">
                                        <changes/>
                                    </xforms:instance>

                                    <xforms:action ev:event="xforms-ready">
                                        <!-- Delete all nodes: this will immediately cause a repeat nodeset change  -->
                                        <xforms:delete nodeset="value"/>
                                    </xforms:action>

                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xforms:repeat nodeset="value" id="my-repeat">
                                    <xforms:setvalue ev:event="xxforms-nodeset-changed" ref="instance('changes')">Got it!</xforms:setvalue>
                                </xforms:repeat>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <values>
                                    <dummy/>
                                </values>
                            </instance>
                            <instance id="changes" model-id="model">
                                <changes>Got it!</changes>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-repeat" index="0"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Support for ev:target='#observer'" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="xforms-server/wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="model">
                                    <!-- TEST: Events to gather -->
                                    <xforms:instance id="events">
                                        <events/>
                                    </xforms:instance>

                                    <xforms:action ev:event="xforms-ready">
                                        <xforms:dispatch name="foo" targetid="group2"/>
                                        <xforms:dispatch name="bar" targetid="group3"/>
                                    </xforms:action>

                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>

                                <xforms:group id="group1">
                                    <!-- Record bubbling events -->
                                    <xforms:insert ev:event="foo bar"
                                                   context="instance('events')" nodeset="*"
                                                   origin="xxforms:element('handler1-event',
                                                            (xxforms:attribute('type', xxforms:event('xxforms:type')),
                                                             xxforms:attribute('target', xxforms:event('xxforms:targetid'))))"/>

                                    <xforms:group id="group2">
                                        <!-- Record only if target is observer -->
                                        <xforms:insert ev:event="foo bar" ev:target="#observer"
                                                       context="instance('events')" nodeset="*"
                                                       origin="xxforms:element('handler2-event',
                                                                (xxforms:attribute('type', xxforms:event('xxforms:type')),
                                                                 xxforms:attribute('target', xxforms:event('xxforms:targetid'))))"/>

                                        <!-- Record if target is observer OR group3 -->
                                        <xforms:insert ev:event="foo bar" ev:target="#observer group3"
                                                       context="instance('events')" nodeset="*"
                                                       origin="xxforms:element('handler3-event',
                                                                (xxforms:attribute('type', xxforms:event('xxforms:type')),
                                                                 xxforms:attribute('target', xxforms:event('xxforms:targetid'))))"/>

                                        <xforms:group id="group3">
                                            <!-- Record only if target is observer -->
                                            <xforms:insert ev:event="foo bar" ev:target="#observer"
                                                           context="instance('events')" nodeset="*"
                                                           origin="xxforms:element('handler4-event',
                                                                    (xxforms:attribute('type', xxforms:event('xxforms:type')),
                                                                     xxforms:attribute('target', xxforms:event('xxforms:targetid'))))"/>
                                        </xforms:group>

                                    </xforms:group>
                                </xforms:group>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="events" model-id="model">
                                <events>
                                    <handler2-event type="foo" target="group2"/>
                                    <handler3-event type="foo" target="group2"/>
                                    <handler1-event type="foo" target="group2"/>
                                    <handler4-event type="bar" target="group3"/>
                                    <handler3-event type="bar" target="group3"/>
                                    <handler1-event type="bar" target="group3"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Client events reach proper repeat iteration if repeat rows are moved" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xforms="http://www.w3.org/2002/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="xforms-server/wrap-server.xpl"/>
                    <!--
                        The two events must end up on controls on the same repeat iteration, even though the first
                        event causes its iteration to move.
                     -->
                    <p:input name="action">
                        <xxforms:action>
                            <xxforms:event name="xxforms-value-change-with-focus-change" source-control-id="plate·3">7FOOBAR</xxforms:event>
                            <xxforms:event name="xxforms-value-change-with-focus-change" source-control-id="leased·3">leased</xxforms:event>
                        </xxforms:action>
                    </p:input>
                    <p:input name="controls">
                        <controls xmlns:xforms="http://www.w3.org/2002/xforms"
                                  xmlns:ev="http://www.w3.org/2001/xml-events"
                                  xmlns:exf="http://www.exforms.org/exf/1-0">
                            <xforms:repeat nodeset="(exf:sort(vehicle, 'plate-number', 'text', 'descending'))" id="repeat">
                                <xforms:input ref="plate-number" id="plate"/>
                                <xforms:select ref="leased" appearance="full" id="leased">
                                    <xforms:item>
                                        <xforms:label/>
                                        <xforms:value>leased</xforms:value>
                                    </xforms:item>
                                </xforms:select>
                            </xforms:repeat>
                        </controls>
                    </p:input>
                    <p:input name="models">
                        <models xmlns:xforms="http://www.w3.org/2002/xforms"
                            xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
                            xmlns:ev="http://www.w3.org/2001/xml-events">
                            <xforms:model id="model" xxforms:encrypt-item-values="false">
                                <xforms:instance xmlns="" id="instance">
                                    <vehicles/>
                                </xforms:instance>
                            </xforms:model>
                        </models>
                    </p:input>
                    <p:input name="instances">
                        <instances>
                            <instance id="instance" model-id="model">
                                <vehicles>
                                    <vehicle>
                                        <plate-number>1CCD412</plate-number>
                                        <leased/>
                                    </vehicle>
                                    <vehicle>
                                        <plate-number>3TRE787</plate-number>
                                        <leased/>
                                    </vehicle>
                                    <vehicle>
                                        <plate-number>6QWA76</plate-number>
                                        <leased/>
                                    </vehicle>
                                </vehicles>
                            </instance>
                        </instances>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>
            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <vehicles>
                                    <vehicle>
                                        <plate-number>7FOOBAR</plate-number>
                                        <leased>leased</leased>
                                    </vehicle>
                                    <vehicle>
                                        <plate-number>3TRE787</plate-number>
                                        <leased/>
                                    </vehicle>
                                    <vehicle>
                                        <plate-number>6QWA76</plate-number>
                                        <leased/>
                                    </vehicle>
                                </vehicles>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="repeat" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="plate·1">7FOOBAR</xxf:control>
                        <xxf:control id="leased·1">leased</xxf:control>
                        <xxf:control id="plate·2">6QWA76</xxf:control>
                        <xxf:control id="plate·3">3TRE787</xxf:control>
                        <xxf:control id="leased·3"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Relevance / readonly state of controls is updated upon Ajax request" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xforms="http://www.w3.org/2002/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="xforms-server/wrap-server.xpl"/>
                    <!--
                        The first event doesn't cause the other controls to block incoming values. So all first three
                        "good" values must make it into the instance. But value "42" blocks the other controls, so the
                        "bad" values must be rejected.
                     -->
                    <p:input name="action">
                        <xxforms:action>
                            <xxforms:event name="xxforms-value-change-with-focus-change" source-control-id="input1">888</xxforms:event>
                            <xxforms:event name="xxforms-value-change-with-focus-change" source-control-id="input2">Good value 2</xxforms:event>
                            <xxforms:event name="xxforms-value-change-with-focus-change" source-control-id="input3">Good value 3</xxforms:event>
                            <xxforms:event name="xxforms-value-change-with-focus-change" source-control-id="input1">42</xxforms:event>
                            <xxforms:event name="xxforms-value-change-with-focus-change" source-control-id="input2">Bad value 2</xxforms:event>
                            <xxforms:event name="xxforms-value-change-with-focus-change" source-control-id="input3">Bad value 3</xxforms:event>
                        </xxforms:action>
                    </p:input>
                    <p:input name="controls">
                        <controls xmlns:xforms="http://www.w3.org/2002/xforms"
                                  xmlns:ev="http://www.w3.org/2001/xml-events">
                            <xforms:input id="input1" ref="value1"/>
                            <xforms:input id="input2" ref="value2"/>
                            <xforms:input id="input3" ref="value3"/>
                        </controls>
                    </p:input>
                    <p:input name="models">
                        <models xmlns:xforms="http://www.w3.org/2002/xforms"
                            xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
                            xmlns:ev="http://www.w3.org/2001/xml-events">
                            <xforms:model id="model" xxforms:encrypt-item-values="false">
                                <xforms:instance xmlns="" id="instance">
                                    <form/>
                                </xforms:instance>
                                <xforms:bind nodeset="value2" relevant="../value1 != '42'"/>
                                <xforms:bind nodeset="value3" readonly="../value1 = '42'"/>
                            </xforms:model>
                        </models>
                    </p:input>
                    <p:input name="instances">
                        <instances>
                            <instance id="instance" model-id="model">
                                <form>
                                    <value1/>
                                    <value2/>
                                    <value3/>
                                </form>
                            </instance>
                        </instances>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>
            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <form>
                                    <value1>42</value1>
                                    <value2>Good value 2</value2>
                                    <value3>Good value 3</value3>
                                </form>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="input1">42</xxf:control>
                        <xxf:control id="input2" relevant="false"/>
                        <xxf:control id="input3" readonly="true">Good value 3</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Test of capture, target, and bubbling phases" name="oxf:pipeline">
        <input name="config" href="xforms-server/wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:exf="http://www.exforms.org/exf/1-0">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance xmlns="">
                                <name>Ada</name>
                            </instance>
                        </xforms:instance>

                        <!-- TEST: Events to gather -->
                        <xforms:instance id="events">
                            <events/>
                        </xforms:instance>

                        <xforms:action ev:event="xforms-ready">
                            <xforms:dispatch name="my-event" targetid="my-input"/>
                        </xforms:action>

                    </xforms:model>
                </xhtml:head>
                <xhtml:body>
                    <xforms:group id="my-group">
                        <xforms:insert ev:event="my-event" ev:phase="capture"
                                       context="instance('events')" nodeset="*"
                                       origin="xxforms:element('group1',
                                                (xxforms:attribute('type', xxforms:event('xxforms:type')),
                                                 xxforms:attribute('phase', event('xxforms:phase')),
                                                 xxforms:attribute('target', xxforms:event('xxforms:targetid'))))"/>
                        <xforms:insert ev:event="my-event" ev:phase="target"
                                       context="instance('events')" nodeset="*"
                                       origin="xxforms:element('group2',
                                                (xxforms:attribute('type', xxforms:event('xxforms:type')),
                                                 xxforms:attribute('phase', event('xxforms:phase')),
                                                 xxforms:attribute('target', xxforms:event('xxforms:targetid'))))"/>
                        <xforms:insert ev:event="my-event" ev:phase="bubbling"
                                       context="instance('events')" nodeset="*"
                                       origin="xxforms:element('group3',
                                                (xxforms:attribute('type', xxforms:event('xxforms:type')),
                                                 xxforms:attribute('phase', event('xxforms:phase')),
                                                 xxforms:attribute('target', xxforms:event('xxforms:targetid'))))"/>
                        <xforms:insert ev:event="my-event" ev:phase="default"
                                       context="instance('events')" nodeset="*"
                                       origin="xxforms:element('group4',
                                                (xxforms:attribute('type', xxforms:event('xxforms:type')),
                                                 xxforms:attribute('phase', event('xxforms:phase')),
                                                 xxforms:attribute('target', xxforms:event('xxforms:targetid'))))"/>

                        <xforms:input id="my-input" ref="name">
                            <xforms:insert ev:event="my-event" ev:phase="capture"
                                           context="instance('events')" nodeset="*"
                                           origin="xxforms:element('input1',
                                                    (xxforms:attribute('type', xxforms:event('xxforms:type')),
                                                     xxforms:attribute('phase', event('xxforms:phase')),
                                                     xxforms:attribute('target', xxforms:event('xxforms:targetid'))))"/>
                            <xforms:insert ev:event="my-event" ev:phase="target"
                                           context="instance('events')" nodeset="*"
                                           origin="xxforms:element('input2',
                                                    (xxforms:attribute('type', xxforms:event('xxforms:type')),
                                                     xxforms:attribute('phase', event('xxforms:phase')),
                                                     xxforms:attribute('target', xxforms:event('xxforms:targetid'))))"/>
                            <xforms:insert ev:event="my-event" ev:phase="bubbling"
                                           context="instance('events')" nodeset="*"
                                           origin="xxforms:element('input3',
                                                    (xxforms:attribute('type', xxforms:event('xxforms:type')),
                                                     xxforms:attribute('phase', event('xxforms:phase')),
                                                     xxforms:attribute('target', xxforms:event('xxforms:targetid'))))"/>
                            <xforms:insert ev:event="my-event" ev:phase="default"
                                           context="instance('events')" nodeset="*"
                                           origin="xxforms:element('input4',
                                                    (xxforms:attribute('type', xxforms:event('xxforms:type')),
                                                     xxforms:attribute('phase', event('xxforms:phase')),
                                                     xxforms:attribute('target', xxforms:event('xxforms:targetid'))))"/>
                        </xforms:input>
                    </xforms:group>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <name>Ada</name>
                                </instance>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <group1 type="my-event" phase="capture" target="my-input"/>
                                    <input2 type="my-event" phase="target" target="my-input"/>
                                    <input4 type="my-event" phase="target" target="my-input"/>
                                    <group3 type="my-event" phase="bubbling" target="my-input"/>
                                    <group4 type="my-event" phase="bubbling" target="my-input"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-input">Ada</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Event listener on #document" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="xforms-server/wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="model">
                                    <xforms:instance xmlns="" id="instance">
                                        <values>
                                            <value/>
                                        </values>
                                    </xforms:instance>

                                    <xforms:action ev:event="xforms-ready">
                                        <xforms:dispatch name="my-event" targetid="my-input"/>
                                    </xforms:action>

                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xxforms:variable name="answer" select="42"/>
                                <xforms:setvalue ev:observer="#document" ev:event="my-event" ref="value" value="$answer"/>

                                <xforms:input id="my-input" ref="value"/>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <values>
                                    <value>42</value>
                                </values>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-input">42</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Event listener on #document resolves index()" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="xforms-server/wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="model">
                                    <xforms:instance xmlns="" id="instance">
                                        <values>
                                            <value>1</value>
                                            <value>2</value>
                                            <value>3</value>
                                            <value>4</value>
                                            <result/>
                                        </values>
                                    </xforms:instance>

                                    <xforms:action ev:event="xforms-ready">
                                        <xforms:dispatch name="my-event" targetid="my-repeat"/>
                                    </xforms:action>

                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xforms:setvalue ev:observer="#document" ev:event="my-event" ref="result" value="index('my-repeat')"/>

                                <xforms:repeat id="my-repeat" nodeset="value" startindex="3"/>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <values>
                                    <value>1</value>
                                    <value>2</value>
                                    <value>3</value>
                                    <value>4</value>
                                    <result>3</result>
                                </values>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-repeat" index="3"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Top-level event listener implicitly listens on #document" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="xforms-server/wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="model">
                                    <xforms:instance xmlns="" id="instance">
                                        <values>
                                            <value/>
                                        </values>
                                    </xforms:instance>

                                    <xforms:action ev:event="xforms-ready">
                                        <xforms:dispatch name="my-event" targetid="my-input"/>
                                    </xforms:action>

                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xxforms:variable name="answer" select="42"/>
                                <xforms:setvalue ev:event="my-event" ref="value" value="$answer"/>

                                <xforms:input id="my-input" ref="value"/>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <values>
                                    <value>42</value>
                                </values>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-input">42</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="keypress event modifiers and text filtering" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="xforms-server/wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="model">
                                    <xforms:instance xmlns="" id="instance">
                                        <values>
                                            <value/>
                                        </values>
                                    </xforms:instance>

                                    <!-- TEST: Events to gather -->
                                    <xforms:instance id="events">
                                        <events/>
                                    </xforms:instance>

                                    <xforms:action ev:event="xforms-ready">
                                        <!-- Dispatch custom keypress events -->
                                        <xforms:dispatch name="keypress" targetid="my-group">
                                            <xxforms:context name="modifiers" select="'control alt'"/>
                                            <xxforms:context name="text" select="'v'"/>
                                        </xforms:dispatch>
                                        <xforms:dispatch name="keypress" targetid="my-group">
                                            <xxforms:context name="modifiers" select="'control alt'"/>
                                            <xxforms:context name="text" select="'w'"/>
                                        </xforms:dispatch>
                                        <xforms:dispatch name="keypress" targetid="my-group">
                                            <xxforms:context name="modifiers" select="'shift'"/>
                                            <xxforms:context name="text" select="'v'"/>
                                        </xforms:dispatch>
                                    </xforms:action>

                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <!-- Match both -->
                                <xforms:group id="my-group">
                                    <xforms:insert ev:event="keypress" xxforms:modifiers="control alt" xxforms:text="v"
                                                   context="instance('events')" nodeset="*" origin="xxforms:element('handler1')"/>
                                    <xforms:insert ev:event="keypress" xxforms:modifiers="shift" xxforms:text="w"
                                                   context="instance('events')" nodeset="*" origin="xxforms:element('handler2')"/>
                                    <xforms:insert ev:event="keypress" xxforms:modifiers="control alt"
                                                   context="instance('events')" nodeset="*" origin="xxforms:element('handler3')"/>
                                    <xforms:insert ev:event="keypress" xxforms:text="v"
                                                   context="instance('events')" nodeset="*" origin="xxforms:element('handler4')"/>
                                </xforms:group>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <values>
                                    <value/>
                                </values>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <handler1/>
                                    <handler3/>
                                    <handler4/>
                                    <handler3/>
                                    <handler4/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xxforms:show produces client requests to show dialogs" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="xforms-server/wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="model">
                                    <xxforms:show ev:event="xforms-ready" dialog="default-dialog"/>
                                    <xxforms:show ev:event="xforms-ready" dialog="minimal-dialog"/>
                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xxforms:dialog id="minimal-dialog" appearance="minimal" neighbor="show-minimal-dialog">
                                    Body of the dialog.
                                </xxforms:dialog>
                                <xxforms:dialog id="default-dialog">
                                    Body of the dialog.
                                </xxforms:dialog>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>
            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances/>
                        <controls>
                            <control effective-id="minimal-dialog" visible="true" constrain="true"/>
                            <control effective-id="default-dialog" visible="true" constrain="true"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:div id="minimal-dialog" visibility="visible" neighbor="show-minimal-dialog" constrain="true"/>
                        <xxf:div id="default-dialog" visibility="visible" constrain="true"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xxforms:toggle produces client requests to show case" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="xforms-server/wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="model">
                                    <xforms:toggle ev:event="xforms-ready" case="second-case"/>
                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xforms:switch id="switch">
                                    <xforms:case id="first-case"/>
                                    <xforms:case id="second-case"/>
                                </xforms:switch>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>
            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances/>
                        <controls>
                            <control effective-id="switch" case-id="second-case"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:div id="second-case" visibility="visible"/>
                        <xxf:div id="first-case" visibility="hidden"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="XForms 1.1 switch dispatches xforms-enabled/xforms-disabled events" name="oxf:pipeline">
        <input name="config" href="xforms-server/wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <xhtml:head>
                    <xforms:model id="model" xxforms:xforms11-switch="true">
                        <xforms:instance id="instance">
                            <instance>
                                <value>42</value>
                                <value>43</value>
                            </instance>
                        </xforms:instance>

                        <!-- TEST: Events to gather -->
                        <xforms:instance id="events">
                            <events/>
                        </xforms:instance>

                        <!-- Toggle -->
                        <xforms:toggle ev:event="xforms-ready" case="case2"/>
                    </xforms:model>
                </xhtml:head>
                <xhtml:body>

                    <xforms:insert ev:event="#all"
                                   context="instance('events')" nodeset="*"
                                   origin="xxforms:element('event',
                                            (xxforms:attribute('type', xxforms:event('xxforms:type')),
                                             xxforms:attribute('target', xxforms:event('xxforms:targetid')),
                                             xxforms:attribute('indexes', string-join(xxforms:event('xxforms:repeat-indexes'), ' '))))"/>

                    <xforms:switch id="my-switch">
                        <xforms:case id="case1">
                            <xforms:input id="input1" ref="value[1]"/>
                        </xforms:case>
                        <xforms:case id="case2">
                            <xforms:input id="input2" ref="value[2]"/>
                        </xforms:case>
                    </xforms:switch>

                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <value>42</value>
                                    <value>43</value>
                                </instance>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-enabled" target="my-switch" indexes=""/>
                                    <event type="xforms-enabled" target="input1" indexes=""/>
                                    <event type="xforms-deselect" target="case1" indexes=""/>
                                    <event type="xforms-disabled" target="input1" indexes=""/>
                                    <event type="xforms-enabled" target="input2" indexes=""/>
                                    <event type="xforms-select" target="case2" indexes=""/>
                                </events>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-switch" case-id="case2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:div id="case2" visibility="visible"/>
                        <xxf:div id="case1" visibility="hidden"/>
                        <xxf:control id="input1" relevant="false"/>
                        <xxf:control id="input2">43</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Dialog dispatches xforms-enabled/xforms-disabled events" name="oxf:pipeline">
        <input name="config" href="xforms-server/wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <xhtml:head>
                    <xforms:model id="model" xxforms:xforms11-switch="true">
                        <xforms:instance id="instance">
                            <instance>
                                <value>42</value>
                                <value>43</value>
                            </instance>
                        </xforms:instance>

                        <!-- TEST: Events to gather -->
                        <xforms:instance id="events">
                            <events/>
                        </xforms:instance>

                        <!-- Show/hide -->
                        <xforms:action ev:event="xforms-ready">
                            <xxforms:show dialog="my-dialog"/>
                            <xxforms:hide dialog="my-dialog"/>
                        </xforms:action>
                    </xforms:model>
                </xhtml:head>
                <xhtml:body>

                    <xforms:insert ev:event="#all"
                                   context="instance('events')" nodeset="*"
                                   origin="xxforms:element('event',
                                            (xxforms:attribute('type', xxforms:event('xxforms:type')),
                                             xxforms:attribute('target', xxforms:event('xxforms:targetid')),
                                             xxforms:attribute('indexes', string-join(xxforms:event('xxforms:repeat-indexes'), ' '))))"/>

                    <xxforms:dialog id="my-dialog">
                        <xforms:input id="input1" ref="value[1]"/>
                        <xforms:input id="input2" ref="value[2]"/>
                    </xxforms:dialog>

                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <value>42</value>
                                    <value>43</value>
                                </instance>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <!-- TODO: we cannot dispatch this to my-dialog before it is enabled -->
                                    <event type="xxforms-dialog-open" target="my-dialog" indexes=""/>
                                    <event type="xforms-enabled" target="input1" indexes=""/>
                                    <event type="xforms-enabled" target="input2" indexes=""/>
                                    <event type="xxforms-dialog-close" target="my-dialog" indexes=""/>
                                    <event type="xforms-disabled" target="input1" indexes=""/>
                                    <event type="xforms-disabled" target="input2" indexes=""/>
                                </events>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-dialog" visible="false"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:div id="my-dialog" visibility="hidden"/>
                        <xxf:control id="input1" relevant="false"/>
                        <xxf:control id="input2" relevant="false"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <!--

    TODO:

    * xxforms-value-changed

    TODO: More tests of client events:

    # In Noscript mode
        * events are reordered so that "activation" events come last (client might send them in another order)
        * special handling of checkboxes blanking takes place
    # If there are contiguous value change events for a given controls, they are combined (check number of value changes)
    # If the target is within a repeat, xxforms-repeat-focus is dispatched
    # For XFormsOutput, DOMFocusIn translates into:
        * DOMFocusIn
        * If the output is not readonly, followed by DOMActivate (not sure why)
    # A value change with focus change translates into:
        * Setting the external value into the instance
        * DOMFocusOut
        * DOMFocusIn
    -->

</group>
