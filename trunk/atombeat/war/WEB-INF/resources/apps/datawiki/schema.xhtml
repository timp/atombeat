<!--
    Copyright (C) 2010 University of Oxford

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:xforms="http://www.w3.org/2002/xforms"
      xmlns:xs="http://www.w3.org/2001/XMLSchema"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
      xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
      xmlns:atom="http://www.w3.org/2005/Atom">
      
    <head>
        <title>AtomBeat DataWiki</title>
        
        <xforms:model id="mod-main">
        
			<xforms:submission 
				id="sub-get-entry"
				resource="{xxforms:get-request-parameter('entry')}"
				method="get"
				replace="instance"
				instance="ins-entry">
			</xforms:submission>        

			<xforms:submission 
				id="sub-refresh-entry"
				resource="{instance('ins-entry')/atom:link[@rel='edit']/@href}"
				method="get"
				replace="instance"
				instance="ins-entry">
                <xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while saving changes.</xforms:message>
		        <xforms:message ev:event="xforms-submit-done" level="modal">The data have been restored to the last saved version.</xforms:message>
			</xforms:submission>        

			<xforms:send ev:event="xforms-model-construct-done" submission="sub-get-entry"/>
			
            <xforms:instance id="ins-entry">
            	<atom:entry/>
            </xforms:instance>
            
            <xforms:bind nodeset="instance('ins-entry')/atom:content/table/thead/tr/th">
            
            	<xforms:bind nodeset="required" type="xs:boolean"/>
            	<xforms:bind nodeset="min" relevant="../datatype = 'integer' or ../datatype='decimal'"/>
            	<xforms:bind nodeset="max" relevant="../datatype = 'integer' or ../datatype='decimal'"/>
            	<xforms:bind nodeset="pattern" relevant="../datatype = 'string' and empty(../enumeration/item)"/>
            	<xforms:bind nodeset="enumeration" relevant="../datatype != 'boolean' and ( empty(../pattern/text()) or ../pattern/text() = '') "/>

            </xforms:bind>
            
            <xforms:bind nodeset="instance('ins-th-template')">
            
            	<xforms:bind nodeset="required" type="xs:boolean"/>
            	<xforms:bind nodeset="min" relevant="../datatype = 'integer' or ../datatype='decimal'"/>
            	<xforms:bind nodeset="max" relevant="../datatype = 'integer' or ../datatype='decimal'"/>
            	<xforms:bind nodeset="pattern" relevant="../datatype = 'string' and empty(../enumeration/item)"/>
            	<xforms:bind nodeset="enumeration" relevant="../datatype != 'boolean' and ( empty(../pattern/text()) or ../pattern/text() = '') "/>

            </xforms:bind>
            
            <xforms:submission
            	id="sub-put-entry"
            	resource="{instance('ins-entry')/atom:link[@rel='edit']/@href}"
            	ref="instance('ins-entry')"
            	method="put"
            	mediatype="application/atom+xml"
            	replace="instance"
            	instance="ins-entry"
            	validate="false">
                <xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while reloading data.</xforms:message>
		        <xforms:message ev:event="xforms-submit-done" level="modal">Your changes have been saved. Thank you.</xforms:message>
           	</xforms:submission>
           	
           	<xforms:instance id="ins-th-template">
           		<th xmlns="">
           			<label>new column</label>
           			<datatype>string</datatype>
           			<required>false</required>
           			<default/>
					<min bound="inclusive"/>
					<max bound="inclusive"/>
					<pattern/>
					<enumeration/>
           		</th>
           	</xforms:instance>
           	
           	<xforms:instance id="ins-td-template">
           		<td xmlns=""/>
           	</xforms:instance>
           	
           	<xforms:instance id="ins-item-template">
           		<item xmlns=""/>
           	</xforms:instance>
           	
           	<!-- initialise row template depending on number of headers -->
           	<xforms:action ev:event="xforms-model-construct-done" xxforms:iterate="instance('ins-entry')/atom:content/table/thead/tr/th">
           		<xforms:insert context="instance('ins-row-template')" nodeset="td" origin="instance('ins-cell-template')"/> 
           	</xforms:action>
           	
           	<xforms:instance id="ins-datatypes">
           		<items xmlns="">
					<item>
						<label>string</label>
						<value>string</value>
					</item>
					<item>
						<label>decimal</label>
						<value>decimal</value>
					</item>
					<item>
						<label>integer</label>
						<value>integer</value>
					</item>
					<item>
						<label>boolean</label>
						<value>boolean</value>
					</item>
					<item>
						<label>date</label>
						<value>date</value>
					</item>
					<item>
						<label>time</label>
						<value>time</value>
					</item>
           		</items>
           	</xforms:instance>

        </xforms:model>
        
        <link rel="stylesheet" type="text/css" href="/ops/yui/tabview/assets/skins/sam/tabview.css"></link>
        <link rel="stylesheet" type="text/css" href="/ops/yui/datatable/assets/skins/sam/datatable.css"></link>

        <style type="text/css">
.xforms-repeat-selected-item-1 {
	background-color: inherit;
}        
        </style>

    </head>
    
    <body>

    	<xforms:group ref="instance('ins-entry')">
	
			<p><a href="./">DataWiki</a></p>
			
			<h1><xforms:output ref="atom:title"/></h1>  
			
			<p></p>  	
    	
    		<div class="yui-navset yui-navset-top">
    			<ul class="yui-nav">
    				<li>
    					<a href="view?entry={atom:link[@rel='edit']/@href}">
	    					<em>View</em>
    					</a>
    				</li>
    				<li>
    					<a href="edit?entry={atom:link[@rel='edit']/@href}">
	    					<em>Edit</em>
    					</a>
   					</li>
    				<li class="selected">
    					<a href="schema?entry={atom:link[@rel='edit']/@href}">
	    					<em>Schema</em>
    					</a>
   					</li>
    			</ul>
    			
    			<div class="yui-content">
    				
    				<p>
    					<xforms:submit submission="sub-put-entry">
    						<xforms:label><img src="/apps/fr/style/save.gif"/> Save Changes</xforms:label>
   						</xforms:submit>
    					<xforms:submit submission="sub-refresh-entry">
    						<xforms:label><img src="/apps/fr/style/trash.gif"/> Discard Changes</xforms:label>
   						</xforms:submit>
    				</p>
    				
    				<hr/>
    			
					<xforms:group ref="atom:content/table">
					
	    				<h3>Add a Column</h3>

						<xforms:group ref="instance('ins-th-template')">
						
							<p>
								<xforms:input ref="label">
									<xforms:label>Label: </xforms:label>
								</xforms:input>
							</p>
							
							<p>
								<xforms:select1 ref="datatype">
									<xforms:label>Datatype: </xforms:label>
									<xforms:itemset nodeset="instance('ins-datatypes')/item">
										<xforms:label ref="label"/>
										<xforms:value ref="value"/>
									</xforms:itemset>
								</xforms:select1>
							</p>
							
							<p>
								<xforms:input ref="required">
									<xforms:label>Required: </xforms:label>
								</xforms:input>
							</p>
							
							<p>
								<xforms:input ref="default">
									<xforms:label>Default value: </xforms:label>
								</xforms:input>
							</p>
							
							<p>
								<xforms:input ref="min">
									<xforms:label>Minimum: </xforms:label>
								</xforms:input>
								<xforms:select1 ref="min/@bound">
									<xforms:label/>
									<xforms:item>
										<xforms:label>inclusive</xforms:label>
										<xforms:value>inclusive</xforms:value>
									</xforms:item>
									<xforms:item>
										<xforms:label>exclusive</xforms:label>
										<xforms:value>exclusive</xforms:value>
									</xforms:item>
								</xforms:select1>
							</p>
							
							<p>
								<xforms:input ref="max">
									<xforms:label>Maximum: </xforms:label>
								</xforms:input>
								<xforms:select1 ref="max/@bound">
									<xforms:label/>
									<xforms:item>
										<xforms:label>inclusive</xforms:label>
										<xforms:value>inclusive</xforms:value>
									</xforms:item>
									<xforms:item>
										<xforms:label>exclusive</xforms:label>
										<xforms:value>exclusive</xforms:value>
									</xforms:item>
								</xforms:select1>
							</p>
							
							<p>
								<xforms:input ref="pattern">
									<xforms:label>Pattern: </xforms:label>
								</xforms:input>
							</p>
							
							<xforms:group ref="enumeration">
							
								<p>Enumeration: </p>
								<div class="yui-dt">
									<div class="yui-dt-hd">
										<table class="yui-dt-table">
											<thead>
												<tr>
													<th>
														<div class="yui-dt-liner">
										                    <xforms:trigger appearance="minimal">
										                        <xforms:label><img src="/apps/fr/style/add.gif"/></xforms:label>
										                        <xforms:insert 
										                            ev:event="DOMActivate" 
										                            context="." 
										                            nodeset="item" 
										                            at="1" 
										                            position="before" 
										                            origin="instance('ins-item-template')"/>
										                    </xforms:trigger>
														</div>
													</th>
													<th>
														<div class="yui-dt-liner">
										                    <xforms:trigger appearance="minimal">
										                        <xforms:label>Add an Item</xforms:label>
										                        <xforms:insert 
										                            ev:event="DOMActivate" 
										                            context="." 
										                            nodeset="item" 
										                            at="1" 
										                            position="before" 
										                            origin="instance('ins-item-template')"/>
										                    </xforms:trigger>
														</div>
													</th>
												</tr>
											</thead>
											<tbody class="yui-dt-data">
												<xforms:repeat 
													nodeset="item" 
													id="rep-item">
													<tr class="
														{if ( position() = 1 ) then 'yui-dt-first' else '' }
														{if ( position() mod 2 = 0 ) then 'yui-dt-even' else 'yui-dt-odd' }">
														<td>
															<div class="yui-dt-liner">
											                    <xforms:trigger appearance="minimal">
											                        <xforms:label><img src="/apps/fr/style/add.gif"/></xforms:label>
											                        <xforms:insert 
											                            ev:event="DOMActivate" 
											                            context="." 
											                            nodeset="." 
											                            at="position()" 
											                            position="after" 
											                            origin="instance('ins-item-template')"/>
											                    </xforms:trigger>
											                    <xforms:trigger appearance="minimal">
										                            <xforms:delete 
										                                ev:event="DOMActivate" 
										                                context="." 
										                                nodeset="." 
										                                at="index('rep-item')"/>
										                            <xforms:label><img src="/apps/fr/style/delete.gif"/></xforms:label>
										                        </xforms:trigger>
										                        <xforms:trigger appearance="minimal" ref=".[preceding-sibling::*]">
										                            <xforms:label><img src="/apps/fr/style/up.gif"/></xforms:label>
										                            <xforms:action ev:event="DOMActivate">
										                                <xforms:insert origin="context()" nodeset="preceding-sibling::*[1]" position="before"/>
										                                <xforms:delete nodeset="."/>
										                            </xforms:action>
										                        </xforms:trigger>
										                        <xforms:trigger appearance="minimal" ref=".[following-sibling::*]">
										                            <xforms:label><img src="/apps/fr/style/down.gif"/></xforms:label>
										                            <xforms:action ev:event="DOMActivate">
										                                <xforms:insert origin="context()" nodeset="following-sibling::*[1]"/>
										                                <xforms:delete nodeset="."/>
										                            </xforms:action>
										                        </xforms:trigger>
															</div>
														</td>
														<td>
															<xforms:input ref=".">
																<xforms:label/>
															</xforms:input>
														</td>
													</tr>
												</xforms:repeat>
											</tbody>
										</table>
									</div>
								</div>
							</xforms:group>

						</xforms:group>
	    				
	    				<p>
		                    <xforms:trigger>
		                        <xforms:label><img src="/apps/fr/style/add.gif"/> Add Column</xforms:label>
		                        <xforms:insert 
		                            ev:event="DOMActivate" 
		                            context="thead/tr" 
		                            nodeset="th" 
		                            at="last()" 
		                            position="after" 
		                            origin="instance('ins-th-template')"/>
	                            <xforms:action ev:event="DOMActivate" xxforms:iterate="tbody/tr">
		                            <xforms:insert
		                            	context="."
		                            	nodeset="td"
		                            	at="last()"
		                            	position="after"
		                            	origin="instance('ins-td-template')"/>
	                            	<xforms:setvalue
	                            		ref="td[last()]"
	                            		value="instance('ins-th-template')/default"/>
	                            </xforms:action>
		                    </xforms:trigger>
						</p>
						<hr/>
						
						<xforms:repeat nodeset="thead/tr/th" id="rep-th">
						
							<h2><xforms:output ref="label"/></h2>
							
							<p>
								<xforms:input ref="label">
									<xforms:label>Label: </xforms:label>
								</xforms:input>
							</p>
							
							<p>
								<xforms:select1 ref="datatype">
									<xforms:label>Datatype: </xforms:label>
									<xforms:itemset nodeset="instance('ins-datatypes')/item">
										<xforms:label ref="label"/>
										<xforms:value ref="value"/>
									</xforms:itemset>
								</xforms:select1>
							</p>
							
							<p>
								<xforms:input ref="required">
									<xforms:label>Required: </xforms:label>
								</xforms:input>
							</p>
							
							<p>
								<xforms:input ref="default">
									<xforms:label>Default value: </xforms:label>
								</xforms:input>
							</p>
							
							<p>
								<xforms:input ref="min">
									<xforms:label>Minimum: </xforms:label>
								</xforms:input>
								<xforms:select1 ref="min/@bound">
									<xforms:label/>
									<xforms:item>
										<xforms:label>inclusive</xforms:label>
										<xforms:value>inclusive</xforms:value>
									</xforms:item>
									<xforms:item>
										<xforms:label>exclusive</xforms:label>
										<xforms:value>exclusive</xforms:value>
									</xforms:item>
								</xforms:select1>
							</p>
							
							<p>
								<xforms:input ref="max">
									<xforms:label>Maximum: </xforms:label>
								</xforms:input>
								<xforms:select1 ref="max/@bound">
									<xforms:label/>
									<xforms:item>
										<xforms:label>inclusive</xforms:label>
										<xforms:value>inclusive</xforms:value>
									</xforms:item>
									<xforms:item>
										<xforms:label>exclusive</xforms:label>
										<xforms:value>exclusive</xforms:value>
									</xforms:item>
								</xforms:select1>
							</p>

							<p>
								<xforms:input ref="pattern">
									<xforms:label>Pattern: </xforms:label>
								</xforms:input>
							</p>


							<xforms:group ref="enumeration">
							
								<p>Enumeration: </p>
								<div class="yui-dt">
									<div class="yui-dt-hd">
										<table class="yui-dt-table">
											<thead>
												<tr>
													<th>
														<div class="yui-dt-liner">
										                    <xforms:trigger appearance="minimal">
										                        <xforms:label><img src="/apps/fr/style/add.gif"/></xforms:label>
										                        <xforms:insert 
										                            ev:event="DOMActivate" 
										                            context="." 
										                            nodeset="item" 
										                            at="1" 
										                            position="before" 
										                            origin="instance('ins-item-template')"/>
										                    </xforms:trigger>
														</div>
													</th>
													<th>
														<div class="yui-dt-liner">
										                    <xforms:trigger appearance="minimal">
										                        <xforms:label>Add an Item</xforms:label>
										                        <xforms:insert 
										                            ev:event="DOMActivate" 
										                            context="." 
										                            nodeset="item" 
										                            at="1" 
										                            position="before" 
										                            origin="instance('ins-item-template')"/>
										                    </xforms:trigger>
														</div>
													</th>
												</tr>
											</thead>
											<tbody class="yui-dt-data">
												<xforms:repeat 
													nodeset="item" 
													id="rep-entry-item">
													<tr class="
														{if ( position() = 1 ) then 'yui-dt-first' else '' }
														{if ( position() mod 2 = 0 ) then 'yui-dt-even' else 'yui-dt-odd' }">
														<td>
															<div class="yui-dt-liner">
											                    <xforms:trigger appearance="minimal">
											                        <xforms:label><img src="/apps/fr/style/add.gif"/></xforms:label>
											                        <xforms:insert 
											                            ev:event="DOMActivate" 
											                            context="." 
											                            nodeset="." 
											                            at="position()" 
											                            position="after" 
											                            origin="instance('ins-item-template')"/>
											                    </xforms:trigger><xforms:trigger appearance="minimal">
										                            <xforms:delete 
										                                ev:event="DOMActivate" 
										                                context="." 
										                                nodeset="." 
										                                at="index('rep-entry-item')"/>
										                            <xforms:label><img src="/apps/fr/style/delete.gif"/></xforms:label>
										                        </xforms:trigger><xforms:trigger appearance="minimal" ref=".[preceding-sibling::*]">
										                            <xforms:label><img src="/apps/fr/style/up.gif"/></xforms:label>
										                            <xforms:action ev:event="DOMActivate">
										                                <xforms:insert origin="context()" nodeset="preceding-sibling::*[1]" position="before"/>
										                                <xforms:delete nodeset="."/>
										                            </xforms:action>
										                        </xforms:trigger><xforms:trigger appearance="minimal" ref=".[following-sibling::*]">
										                            <xforms:label><img src="/apps/fr/style/down.gif"/></xforms:label>
										                            <xforms:action ev:event="DOMActivate">
										                                <xforms:insert origin="context()" nodeset="following-sibling::*[1]"/>
										                                <xforms:delete nodeset="."/>
										                            </xforms:action>
										                        </xforms:trigger>
															</div>
														</td>
														<td>
															<xforms:input ref=".">
																<xforms:label/>
															</xforms:input>
														</td>
													</tr>
												</xforms:repeat>
											</tbody>
										</table>
									</div>
								</div>
							</xforms:group>
							<p>
		                        <xforms:trigger>
		                        	<xforms:action
		                        		ev:event="DOMActivate">
		                        		<xforms:delete
		                        			context="."
		                        			nodeset="."/>	
	                        		</xforms:action>
		                        	<xforms:action
		                        		ev:event="DOMActivate"
		                        		xxforms:iterate="instance('ins-entry')/atom:content/table/tbody/tr">
			                            <xforms:delete 
			                                context="." 
			                                nodeset="td" 
			                                at="index('rep-th')"/>
	                        		</xforms:action>
		                            <xforms:label><img src="/apps/fr/style/delete.gif"/> Delete Column</xforms:label>
		                        </xforms:trigger>
		                        
		                        <xforms:trigger ref=".[preceding-sibling::*]">
		                            <xforms:label><img src="/apps/fr/style/up.gif"/> Move Up</xforms:label>

		                            <xforms:action ev:event="DOMActivate" xxforms:iterate="instance('ins-entry')/atom:content/table/tbody/tr">
		                            	<xforms:insert origin="context()/td[index('rep-th')]" nodeset="context()/td[index('rep-th')-1]" position="before"/> 
		                            	<xforms:delete nodeset="context()/td[index('rep-th')+1]"/>
		                            </xforms:action>
		                            
		                            <xforms:action ev:event="DOMActivate">
		                                <xforms:insert origin="context()" nodeset="preceding-sibling::*[1]" position="before"/>
		                                <xforms:delete nodeset="."/>
		                            </xforms:action>
		                            
		                        </xforms:trigger>
		                        
		                        <xforms:trigger ref=".[following-sibling::*]">
		                            <xforms:label><img src="/apps/fr/style/down.gif"/> Move Down</xforms:label>

		                            <xforms:action ev:event="DOMActivate" xxforms:iterate="instance('ins-entry')/atom:content/table/tbody/tr">
		                            	<xforms:insert origin="context()/td[index('rep-th')]" nodeset="context()/td[index('rep-th')+1]"/> 
		                            	<xforms:delete nodeset="context()/td[index('rep-th')]"/>
		                            </xforms:action>
		                            
		                            <xforms:action ev:event="DOMActivate">
		                                <xforms:insert origin="context()" nodeset="following-sibling::*[1]"/>
		                                <xforms:delete nodeset="."/>
		                            </xforms:action>
		                            
		                        </xforms:trigger>
		                        
		                        
							</p>
							
						</xforms:repeat>
						
					</xforms:group>

    				<hr/>

    				<p>
    					<xforms:submit submission="sub-put-entry">
    						<xforms:label><img src="/apps/fr/style/save.gif"/> Save Changes</xforms:label>
   						</xforms:submit>
    					<xforms:submit submission="sub-refresh-entry">
    						<xforms:label><img src="/apps/fr/style/trash.gif"/> Discard Changes</xforms:label>
   						</xforms:submit>
    				</p>
    			
    			</div>
    			
   			</div>
    			
    	</xforms:group>
    	
    	<xforms:repeat nodeset="instance('ins-table')/thead/tr/th">
    		<p>
    			<xforms:output value="label"/>
    			<xforms:input ref="datatype">
    				<xforms:label>datatype: </xforms:label>
    				<xforms:rebuild ev:event="xforms-value-changed"/>
    			</xforms:input>
    		</p>
    	</xforms:repeat>
    			
    	
    </body>
</html>
