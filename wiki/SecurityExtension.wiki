#summary documentation on the AtomBeat security system

<wiki:toc/>

= Introduction =

AtomBeat implements an experimental security system based on access control lists, inspired by the approach used in NFS and the !WebDav ACL extension. *This security system may have bugs, use at your own risk*. 

We commonly found we were not able to fit our security requirements into the unix model of one user and one group per resource, which eXist implements natively. We typically found that we wanted to set different access rules for two or more different roles or groups of users, e.g., we wanted to be able to configure a collection to allow "authors" to create new members but only update their own members, to allow "editors" to update any member, to allow "readers" to retrieve any member, and to allow authors to grant permission to update their members to other specified authors.  

To support this kind of scenario, AtomBeat implements a *security plugin* for its Atom protocol engine, which can be configured to intercept all incoming requests, and to apply access control lists and allow or deny the request as appropriate. The security plugin is optional, so you don't have to enable it if you don't want to. 

AtomBeat also implements a *security protocol* which enables you to retrieve and update access control lists for a workspace, collections and members, using a subset of the Atom Protocol.

= Authentication; Roles =

*AtomBeat does not implement any kind of authentication*. To use the AtomBeat security system, you will need to implement or configure some sort of authentication yourself. E.g., you could use Spring Security to implement HTTP digest authentication with user credentials stored in a relational database. Or you could use your favourite servlet container's built-in authentication options. Or you could roll your own.

Similarly, *AtomBeat does not implement any kind of user role management*. If you want to use access control entries based on roles (which you can do with AtomBeat), you will first need to implement or configure some sort of role management system yourself. E.g., you could use Spring Security to store and retrieve role information for authenticated users from a relational database. Or you could use your favourite servlet container's built-in role management options. Or you could roll your own.

The point is, AtomBeat expects that, by the time the request reaches AtomBeat for processing, *the user will have already been authenticated*. It also expects that the authenticated user's username will have been stored in a request attribute using the attribute key "user-name" (this is configurable, TODO link to config docs). 

If you are using role-based security, AtomBeat also expects that any roles possessed by the current user will have been stored in a request attribute using the attribute key "user-roles" (also configurable). 

So, whatever authentication and role management system you are using, you will *need to implement a servlet filter to set the required request attributes before the request reaches AtomBeat*. An example of a minimal servlet filter for integration with Spring Security is given below...

{{{
package org.atombeat.http;

import java.io.IOException;

import javax.servlet.FilterChain;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.atombeat.http.HttpFilter;
import org.exist.xquery.value.ValueSequence;
import org.exist.xquery.value.StringValue;
import org.springframework.security.Authentication;
import org.springframework.security.GrantedAuthority;
import org.springframework.security.context.SecurityContextHolder;

public class MinimalSpringSecuritySetUserRequestAttributesFilter extends HttpFilter {

	public static final String USERNAMEREQUESTATTRIBUTEKEY = "user-name";
	public static final String USERROLESREQUESTATTRIBUTEKEY = "user-roles";
	
	@Override
	public void doHttpFilter(HttpServletRequest request, HttpServletResponse response, FilterChain chain) throws IOException, ServletException {

		Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
		
		String name = null;
		
		if (authentication != null) {
			
			name = authentication.getName();
			
			request.setAttribute(USERNAMEREQUESTATTRIBUTEKEY, new StringValue(name));
			
			GrantedAuthority[] authorities = authentication.getAuthorities();

			ValueSequence roles = new ValueSequence();
			
			for (GrantedAuthority a : authorities) {
				StringValue s = new StringValue(a.toString());
				roles.add(s);
			}

			request.setAttribute(USERROLESREQUESTATTRIBUTEKEY, roles);
			
		}
		
		chain.doFilter(request, response);

	}

}
}}}

= Security Procotol =

The AtomBeat workspace, each Atom collection, each collection member, and each media resource, has an associated *security descriptor*, which contains an access control list. Each security descriptor has a URI, and the security descriptor can be retrieved and updated using standard Atom Protocol retrieve member and update member requests (i.e., GET and PUT).

See also the  [http://code.google.com/p/atombeat/source/browse/trunk/atombeat/src/test/java/org/atombeat/TestSecurityProtocol.java TestSecurityProtocol.java] test case.

== Retrieve the Workspace Security Descriptor ==

To retrieve the workspace security descriptor, send a GET request to the security service base URL. E.g., ...

{{{
GET /atombeat/atombeat/security/ HTTP/1.1
Authorization: Basic YWRhbTp0ZXN0
User-Agent: Jakarta Commons-HttpClient/3.1
Host: localhost:8081


HTTP/1.1 200 OK
Server: Apache-Coyote/1.1
pragma: no-cache
Cache-Control: no-cache
Content-Type: application/atom+xml;charset=UTF-8
Transfer-Encoding: chunked
Date: Wed, 23 Jun 2010 17:29:33 GMT

<atom:entry xmlns:atom="http://www.w3.org/2005/Atom">
    <atom:id>http://localhost:8081/atombeat/atombeat/security/</atom:id>
    <atom:title type="text">Security Descriptor</atom:title>
    <atom:link rel="self" href="http://localhost:8081/atombeat/atombeat/security/" type="application/atom+xml"/>
    <atom:link rel="edit" href="http://localhost:8081/atombeat/atombeat/security/" type="application/atom+xml"/>
    <atom:updated>2010-06-23T18:29:33.129+01:00</atom:updated>
    <atom:content type="application/vnd.atombeat+xml">
        <atombeat:security-descriptor xmlns:atombeat="http://purl.org/atombeat/xmlns">
            <atombeat:acl>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_ADMINISTRATOR</atombeat:recipient>
                    <atombeat:permission>CREATE_COLLECTION</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_ADMINISTRATOR</atombeat:recipient>
                    <atombeat:permission>UPDATE_COLLECTION</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_ADMINISTRATOR</atombeat:recipient>
                    <atombeat:permission>LIST_COLLECTION</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_ADMINISTRATOR</atombeat:recipient>
                    <atombeat:permission>CREATE_MEMBER</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_ADMINISTRATOR</atombeat:recipient>
                    <atombeat:permission>RETRIEVE_MEMBER</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_ADMINISTRATOR</atombeat:recipient>
                    <atombeat:permission>UPDATE_MEMBER</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_ADMINISTRATOR</atombeat:recipient>
                    <atombeat:permission>DELETE_MEMBER</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_ADMINISTRATOR</atombeat:recipient>
                    <atombeat:permission>CREATE_MEDIA</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_ADMINISTRATOR</atombeat:recipient>
                    <atombeat:permission>RETRIEVE_MEDIA</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_ADMINISTRATOR</atombeat:recipient>
                    <atombeat:permission>UPDATE_MEDIA</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_ADMINISTRATOR</atombeat:recipient>
                    <atombeat:permission>DELETE_MEDIA</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_ADMINISTRATOR</atombeat:recipient>
                    <atombeat:permission>RETRIEVE_ACL</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_ADMINISTRATOR</atombeat:recipient>
                    <atombeat:permission>UPDATE_ACL</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_ADMINISTRATOR</atombeat:recipient>
                    <atombeat:permission>MULTI_CREATE</atombeat:permission>
                </atombeat:ace><!-- you could also use a wildcard --><!--
            <atombeat:ace>
                <atombeat:type>ALLOW</atombeat:type>
                <atombeat:recipient type="role">ROLE_ADMINISTRATOR</atombeat:recipient>
                <atombeat:permission>*</atombeat:permission>
            </atombeat:ace>
            -->
            </atombeat:acl>
        </atombeat:security-descriptor>
    </atom:content>
</atom:entry>
}}}

== Retrieve a Collection Security Descriptor ==

To retrieve the security descriptor for an Atom collection, list the collection, then follow the `http://purl.org/atombeat/rel/security-descriptor` link found in the collection feed document.

E.g., list a collection...

{{{
GET /atombeat/atombeat/content/foo HTTP/1.1
Authorization: Basic YWRhbTp0ZXN0
User-Agent: Jakarta Commons-HttpClient/3.1
Host: localhost:8081


HTTP/1.1 200 OK
Server: Apache-Coyote/1.1
pragma: no-cache
Cache-Control: no-cache
Content-Type: application/atom+xml;charset=UTF-8
Transfer-Encoding: chunked
Date: Wed, 23 Jun 2010 16:54:21 GMT

<atom:feed xmlns:atom="http://www.w3.org/2005/Atom">
    <atom:id>http://localhost:8081/atombeat/atombeat/content/foo</atom:id>
    <atom:updated>2010-06-23T17:54:21.875+01:00</atom:updated>
    <atom:link rel="self" href="http://localhost:8081/atombeat/atombeat/content/foo" type="application/atom+xml"/>
    <atom:link rel="edit" href="http://localhost:8081/atombeat/atombeat/content/foo" type="application/atom+xml"/>
    <atom:author>
        <atom:name>adam</atom:name>
    </atom:author>
    <atom:title>Test Collection</atom:title>
    <atom:link rel="http://purl.org/atombeat/rel/security-descriptor" href="http://localhost:8081/atombeat/atombeat/security/foo" type="application/atom+xml"/>
</atom:feed>
}}}

...then follow the `http://purl.org/atombeat/rel/security-descriptor` link...

{{{
GET /atombeat/atombeat/security/foo HTTP/1.1
Authorization: Basic YWRhbTp0ZXN0
User-Agent: Jakarta Commons-HttpClient/3.1
Host: localhost:8081


HTTP/1.1 200 OK
Server: Apache-Coyote/1.1
pragma: no-cache
Cache-Control: no-cache
Content-Type: application/atom+xml;charset=UTF-8
Transfer-Encoding: chunked
Date: Wed, 23 Jun 2010 16:54:21 GMT

<atom:entry xmlns:atom="http://www.w3.org/2005/Atom">
    <atom:id>http://localhost:8081/atombeat/atombeat/security/foo</atom:id>
    <atom:title type="text">Security Descriptor</atom:title>
    <atom:link rel="self" href="http://localhost:8081/atombeat/atombeat/security/foo" type="application/atom+xml"/>
    <atom:link rel="edit" href="http://localhost:8081/atombeat/atombeat/security/foo" type="application/atom+xml"/>
    <atom:updated>2010-06-23T17:54:21.879+01:00</atom:updated>
    <atom:content type="application/vnd.atombeat+xml">
        <atombeat:security-descriptor xmlns:atombeat="http://purl.org/atombeat/xmlns">
            <atombeat:acl><!--  
            Authors can create entries and media, and can list the collection,
            but can only retrieve resources they have created.
            -->
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_AUTHOR</atombeat:recipient>
                    <atombeat:permission>CREATE_MEMBER</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_AUTHOR</atombeat:recipient>
                    <atombeat:permission>CREATE_MEDIA</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_AUTHOR</atombeat:recipient>
                    <atombeat:permission>LIST_COLLECTION</atombeat:permission>
                </atombeat:ace><!--
            Editors can list the collection, retrieve and update any member.
            -->
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_EDITOR</atombeat:recipient>
                    <atombeat:permission>LIST_COLLECTION</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_EDITOR</atombeat:recipient>
                    <atombeat:permission>RETRIEVE_MEMBER</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_EDITOR</atombeat:recipient>
                    <atombeat:permission>UPDATE_MEMBER</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_EDITOR</atombeat:recipient>
                    <atombeat:permission>DELETE_MEMBER</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_EDITOR</atombeat:recipient>
                    <atombeat:permission>RETRIEVE_ACL</atombeat:permission>
                </atombeat:ace><!-- Media editors -->
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_MEDIA_EDITOR</atombeat:recipient>
                    <atombeat:permission>LIST_COLLECTION</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_MEDIA_EDITOR</atombeat:recipient>
                    <atombeat:permission>RETRIEVE_MEMBER</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_MEDIA_EDITOR</atombeat:recipient>
                    <atombeat:permission>RETRIEVE_MEDIA</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_MEDIA_EDITOR</atombeat:recipient>
                    <atombeat:permission>UPDATE_MEDIA</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_MEDIA_EDITOR</atombeat:recipient>
                    <atombeat:permission>DELETE_MEDIA</atombeat:permission>
                </atombeat:ace><!--
            Readers can list the collection and retrieve any member.
            -->
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_READER</atombeat:recipient>
                    <atombeat:permission>LIST_COLLECTION</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_READER</atombeat:recipient>
                    <atombeat:permission>RETRIEVE_MEMBER</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_READER</atombeat:recipient>
                    <atombeat:permission>RETRIEVE_MEDIA</atombeat:permission>
                </atombeat:ace><!--
            Data authors can only create media resources with a specific media
            type.
            -->
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="role">ROLE_DATA_AUTHOR</atombeat:recipient>
                    <atombeat:permission>CREATE_MEDIA</atombeat:permission>
                    <atombeat:conditions>
                        <atombeat:condition type="mediarange">application/vnd.ms-excel</atombeat:condition>
                    </atombeat:conditions>
                </atombeat:ace>
            </atombeat:acl>
        </atombeat:security-descriptor>
    </atom:content>
</atom:entry>
}}}

== Retrieve a Member Security Descriptor ==

To retrieve the security descriptor for an Atom collection member, retrieve the member, then follow the `http://purl.org/atombeat/rel/security-descriptor` link found in the Atom entry document.

E.g., retrieve a member...

{{{
GET /atombeat/atombeat/content/foo/4b82ad6c-43d9-481a-9c75-8c99b026f2f8.atom HTTP/1.1
Authorization: Basic YXVkcmV5OnRlc3Q=
User-Agent: Jakarta Commons-HttpClient/3.1
Host: localhost:8081


HTTP/1.1 200 OK
Server: Apache-Coyote/1.1
pragma: no-cache
Cache-Control: no-cache
ETag: "319d8fe2d88f64cef8905fb3a38eb2b9"
Content-Type: application/atom+xml;charset=UTF-8
Transfer-Encoding: chunked
Date: Wed, 23 Jun 2010 17:21:49 GMT

<atom:entry xmlns:atom="http://www.w3.org/2005/Atom">
    <atom:id>http://localhost:8081/atombeat/atombeat/content/foo/4b82ad6c-43d9-481a-9c75-8c99b026f2f8.atom</atom:id>
    <atom:published>2010-06-23T18:21:49.429+01:00</atom:published>
    <atom:updated>2010-06-23T18:21:49.429+01:00</atom:updated>
    <atom:link rel="self" type="application/atom+xml" href="http://localhost:8081/atombeat/atombeat/content/foo/4b82ad6c-43d9-481a-9c75-8c99b026f2f8.atom"/>
    <atom:link xmlns:atombeat="http://purl.org/atombeat/xmlns" atombeat:allow="GET, PUT, DELETE" rel="edit" type="application/atom+xml" href="http://localhost:8081/atombeat/atombeat/content/foo/4b82ad6c-43d9-481a-9c75-8c99b026f2f8.atom"/>
    <atom:author>
        <atom:name>audrey</atom:name>
    </atom:author>
    <atom:title>Test Entry</atom:title>
    <atom:summary>this is a test</atom:summary>
    <atom:link xmlns:atombeat="http://purl.org/atombeat/xmlns" rel="http://purl.org/atombeat/rel/security-descriptor" href="http://localhost:8081/atombeat/atombeat/security/foo/4b82ad6c-43d9-481a-9c75-8c99b026f2f8.atom" type="application/atom+xml" atombeat:allow="GET, PUT"/>
</atom:entry>
}}}

...then follow the `http://purl.org/atombeat/rel/security-descriptor` link...

{{{
GET /atombeat/atombeat/security/foo/4b82ad6c-43d9-481a-9c75-8c99b026f2f8.atom HTTP/1.1
Authorization: Basic YWRhbTp0ZXN0
User-Agent: Jakarta Commons-HttpClient/3.1
Host: localhost:8081


HTTP/1.1 200 OK
Server: Apache-Coyote/1.1
pragma: no-cache
Cache-Control: no-cache
Content-Type: application/atom+xml;charset=UTF-8
Transfer-Encoding: chunked
Date: Wed, 23 Jun 2010 17:21:49 GMT

<atom:entry xmlns:atom="http://www.w3.org/2005/Atom">
    <atom:id>http://localhost:8081/atombeat/atombeat/security/foo/4b82ad6c-43d9-481a-9c75-8c99b026f2f8.atom</atom:id>
    <atom:title type="text">Security Descriptor</atom:title>
    <atom:link rel="self" href="http://localhost:8081/atombeat/atombeat/security/foo/4b82ad6c-43d9-481a-9c75-8c99b026f2f8.atom" type="application/atom+xml"/>
    <atom:link rel="edit" href="http://localhost:8081/atombeat/atombeat/security/foo/4b82ad6c-43d9-481a-9c75-8c99b026f2f8.atom" type="application/atom+xml"/>
    <atom:updated>2010-06-23T18:21:49.436+01:00</atom:updated>
    <atom:content type="application/vnd.atombeat+xml">
        <atombeat:security-descriptor xmlns:atombeat="http://purl.org/atombeat/xmlns">
            <atombeat:acl><!-- 
		    The user who created the resource has full rights.
		    -->
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="user">audrey</atombeat:recipient>
                    <atombeat:permission>RETRIEVE_MEMBER</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="user">audrey</atombeat:recipient>
                    <atombeat:permission>UPDATE_MEMBER</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="user">audrey</atombeat:recipient>
                    <atombeat:permission>DELETE_MEMBER</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="user">audrey</atombeat:recipient>
                    <atombeat:permission>RETRIEVE_MEDIA</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="user">audrey</atombeat:recipient>
                    <atombeat:permission>UPDATE_MEDIA</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="user">audrey</atombeat:recipient>
                    <atombeat:permission>DELETE_MEDIA</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="user">audrey</atombeat:recipient>
                    <atombeat:permission>RETRIEVE_ACL</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="user">audrey</atombeat:recipient>
                    <atombeat:permission>UPDATE_ACL</atombeat:permission>
                </atombeat:ace>
            </atombeat:acl>
        </atombeat:security-descriptor>
    </atom:content>
</atom:entry>
}}} 

== Retrieve a Media Resource Security Descriptor ==

To retrieve the security descriptor for a media resource, obtain a media-link entry, then follow the `http://purl.org/atombeat/rel/media-security-descriptor` link found in the Atom entry document.

E.g., create a media resource...

{{{
POST /atombeat/atombeat/content/foo HTTP/1.1
Authorization: Basic YXVkcmV5OnRlc3Q=
User-Agent: Jakarta Commons-HttpClient/3.1
Host: localhost:8081
Content-Length: 15
Content-Type: text/plain;charset=utf-8

This is a test.


HTTP/1.1 201 Created
Server: Apache-Coyote/1.1
pragma: no-cache
Cache-Control: no-cache
Location: http://localhost:8081/atombeat/atombeat/content/foo/3dbdbac4-affe-4a7a-83c8-ce126e449405.atom
Content-Location: http://localhost:8081/atombeat/atombeat/content/foo/3dbdbac4-affe-4a7a-83c8-ce126e449405.atom
Content-Type: application/atom+xml;charset=UTF-8
Transfer-Encoding: chunked
Date: Wed, 23 Jun 2010 17:24:40 GMT

<atom:entry xmlns:atom="http://www.w3.org/2005/Atom">
    <atom:id>http://localhost:8081/atombeat/atombeat/content/foo/3dbdbac4-affe-4a7a-83c8-ce126e449405.atom</atom:id>
    <atom:published>2010-06-23T18:24:40.587+01:00</atom:published>
    <atom:updated>2010-06-23T18:24:40.587+01:00</atom:updated>
    <atom:link rel="self" type="application/atom+xml" href="http://localhost:8081/atombeat/atombeat/content/foo/3dbdbac4-affe-4a7a-83c8-ce126e449405.atom"/>
    <atom:link xmlns:atombeat="http://purl.org/atombeat/xmlns" atombeat:allow="GET, PUT, DELETE" rel="edit" type="application/atom+xml" href="http://localhost:8081/atombeat/atombeat/content/foo/3dbdbac4-affe-4a7a-83c8-ce126e449405.atom"/>
    <atom:link xmlns:atombeat="http://purl.org/atombeat/xmlns" atombeat:allow="GET, PUT, DELETE" rel="edit-media" type="text/plain" href="http://localhost:8081/atombeat/atombeat/content/foo/3dbdbac4-affe-4a7a-83c8-ce126e449405.media" length="15"/>
    <atom:content src="http://localhost:8081/atombeat/atombeat/content/foo/3dbdbac4-affe-4a7a-83c8-ce126e449405.media" type="text/plain"/>
    <atom:title type="text">download-3dbdbac4-affe-4a7a-83c8-ce126e449405.media</atom:title>
    <atom:summary type="text">media resource</atom:summary>
    <atom:author>
        <atom:name>audrey</atom:name>
    </atom:author>
    <atom:link xmlns:atombeat="http://purl.org/atombeat/xmlns" rel="http://purl.org/atombeat/rel/security-descriptor" href="http://localhost:8081/atombeat/atombeat/security/foo/3dbdbac4-affe-4a7a-83c8-ce126e449405.atom" type="application/atom+xml" atombeat:allow="GET, PUT"/>
    <atom:link xmlns:atombeat="http://purl.org/atombeat/xmlns" rel="http://purl.org/atombeat/rel/media-security-descriptor" href="http://localhost:8081/atombeat/atombeat/security/foo/3dbdbac4-affe-4a7a-83c8-ce126e449405.media" type="application/atom+xml" atombeat:allow="GET, PUT"/>
</atom:entry>
}}}

...then follow the `http://purl.org/atombeat/rel/media-security-descriptor` link...

{{{
GET /atombeat/atombeat/security/foo/3dbdbac4-affe-4a7a-83c8-ce126e449405.media HTTP/1.1
Authorization: Basic YXVkcmV5OnRlc3Q=
User-Agent: Jakarta Commons-HttpClient/3.1
Host: localhost:8081


HTTP/1.1 200 OK
Server: Apache-Coyote/1.1
pragma: no-cache
Cache-Control: no-cache
Content-Type: application/atom+xml;charset=UTF-8
Transfer-Encoding: chunked
Date: Wed, 23 Jun 2010 17:24:40 GMT

<atom:entry xmlns:atom="http://www.w3.org/2005/Atom">
    <atom:id>http://localhost:8081/atombeat/atombeat/security/foo/3dbdbac4-affe-4a7a-83c8-ce126e449405.media</atom:id>
    <atom:title type="text">Security Descriptor</atom:title>
    <atom:link rel="self" href="http://localhost:8081/atombeat/atombeat/security/foo/3dbdbac4-affe-4a7a-83c8-ce126e449405.media" type="application/atom+xml"/>
    <atom:link rel="edit" href="http://localhost:8081/atombeat/atombeat/security/foo/3dbdbac4-affe-4a7a-83c8-ce126e449405.media" type="application/atom+xml"/>
    <atom:updated>2010-06-23T18:24:40.596+01:00</atom:updated>
    <atom:content type="application/vnd.atombeat+xml">
        <atombeat:security-descriptor xmlns:atombeat="http://purl.org/atombeat/xmlns">
            <atombeat:acl><!-- 
		    The user who created the resource has full rights.
		    -->
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="user">audrey</atombeat:recipient>
                    <atombeat:permission>RETRIEVE_MEMBER</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="user">audrey</atombeat:recipient>
                    <atombeat:permission>UPDATE_MEMBER</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="user">audrey</atombeat:recipient>
                    <atombeat:permission>DELETE_MEMBER</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="user">audrey</atombeat:recipient>
                    <atombeat:permission>RETRIEVE_MEDIA</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="user">audrey</atombeat:recipient>
                    <atombeat:permission>UPDATE_MEDIA</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="user">audrey</atombeat:recipient>
                    <atombeat:permission>DELETE_MEDIA</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="user">audrey</atombeat:recipient>
                    <atombeat:permission>RETRIEVE_ACL</atombeat:permission>
                </atombeat:ace>
                <atombeat:ace>
                    <atombeat:type>ALLOW</atombeat:type>
                    <atombeat:recipient type="user">audrey</atombeat:recipient>
                    <atombeat:permission>UPDATE_ACL</atombeat:permission>
                </atombeat:ace>
            </atombeat:acl>
        </atombeat:security-descriptor>
    </atom:content>
</atom:entry>
}}}

== Updating a Security Descriptor ==

Any security descriptor can be updated using the standard Atom Protocol update request, i.e., a PUT with an Atom entry document, to the URL found in the `edit` link.

E.g., updating a collection security descriptor (in this case, to remove all access control entries)...

{{{
PUT /atombeat/atombeat/security/foo HTTP/1.1
Authorization: Basic YWRhbTp0ZXN0
User-Agent: Jakarta Commons-HttpClient/3.1
Host: localhost:8081
Content-Length: 255
Content-Type: application/atom+xml; charset=utf-8

<atom:entry xmlns:atom="http://www.w3.org/2005/Atom">
	<atom:content type="application/vnd.atombeat+xml">
		<atombeat:security-descriptor xmlns:atombeat="http://purl.org/atombeat/xmlns">
			<atombeat:acl/>
		</atombeat:security-descriptor>
	</atom:content>
</atom:entry>


HTTP/1.1 200 OK
Server: Apache-Coyote/1.1
pragma: no-cache
Cache-Control: no-cache
Content-Type: application/atom+xml;charset=UTF-8
Transfer-Encoding: chunked
Date: Wed, 23 Jun 2010 17:31:55 GMT

<atom:entry xmlns:atom="http://www.w3.org/2005/Atom">
    <atom:id>http://localhost:8081/atombeat/atombeat/security/foo</atom:id>
    <atom:title type="text">Security Descriptor</atom:title>
    <atom:link rel="self" href="http://localhost:8081/atombeat/atombeat/security/foo" type="application/atom+xml"/>
    <atom:link rel="edit" href="http://localhost:8081/atombeat/atombeat/security/foo" type="application/atom+xml"/>
    <atom:updated>2010-06-23T18:31:55.792+01:00</atom:updated>
    <atom:content type="application/vnd.atombeat+xml">
        <atombeat:security-descriptor xmlns:atombeat="http://purl.org/atombeat/xmlns">
            <atombeat:acl/>
        </atombeat:security-descriptor>
    </atom:content>
</atom:entry>
}}}

= Security Concepts =

== ACLs and ACEs ==

The AtomBeat security system divides the Atom Protocol and AtomBeat protocol extensions into the following abstract operations:
 
  * CREATE_MEMBER
  * RETRIEVE_MEMBER
  * UPDATE_MEMBER
  * DELETE_MEMBER
  * CREATE_MEDIA
  * RETRIEVE_MEDIA
  * UPDATE_MEDIA
  * DELETE_MEDIA
  * LIST_COLLECTION
  * CREATE_COLLECTION
  * UPDATE_COLLECTION
  * RETRIEVE_ACL
  * UPDATE_ACL
  * MULTI_CREATE
  * RETRIEVE_HISTORY
  * RETRIEVE_REVISION

These are also the names of the permissions that can be allowed or denied in access control entries. I.e., there is a one-to-one correspondance between protocol operations and permissions.

An access control list (ACL) comprises a sequence of access control entries (ACEs). Each ACE has a *type* (either ALLOW or DENY), a *recipient* (the type of the recipient could be user, group or role), a *permission*, and optionally, a list of *conditions*.

The AtomBeat workspace, each Atom collection, each collection member, and each media resource, has an associated *security descriptor*. The security descriptor encapsulates the ACL for that resource. A security descriptor can also define local groups, see below.

== Processing ACLs ==

For any given protocol operation, *up to three* access control lists could be involved in reaching a decision about whether the operation should be allowed to execute. For example, when updating a collection member, the member's ACL, the collection ACL, and the workspace ACL, could all be involved. When creating a new collection member, only the collection ACL and the workspace ACL will be involved. When creating a new collection, only the workspace ACL is involved.

For any given protocol operation, the relevant access control lists are processed in a particular order. By default, the workspace ACL is processed first, then the collection ACL, then the member or media resource ACL. *The first matching ACE is applied, and ACL processing terminates*. This means that the workspace ACL overrides any collection ACLs, and collection ACLs override member ACLs. However, this order of precendence is configurable, @@TODO link to config docs.

For a definitive account of the AtomBeat ACL processing behaviour, see the [http://code.google.com/p/atombeat/source/browse/trunk/atombeat/war/atombeat/lib/test-atom-security.xql test-atom-security.xql] script.

== Configuring Default ACLs ==

When new collections, members or media resources are created, the security plugin will attempt to install a default security descriptor at the time of creation. To obtain a default security descriptor, the $config:default-workspace-security-descriptor variable, and config:default-collection-security-descriptor() and config:default-resource-security-descriptor() functions are invoked as appropriate to the resource being created. These variables/functions are defined in the shared.xqm configuration file, so you will need to override these functions to implement appropriate defaults for your configuration. See also @@TODO link to config docs

For an example of configuring and verifying default ACLs for an AtomBeat instance, see the [http://code.google.com/p/atombeat/source/browse/trunk/atombeat/war/atombeat/config/shared.xqm shared.xqm] configuration file in the main AtomBeat project, and the [http://code.google.com/p/atombeat/source/browse/trunk/atombeat/src/test/java/org/atombeat/TestDefaultSecurityPolicy.java TestDefaultSecurityPolicy.java] test case.

== Groups ==

Note that AtomBeat allows the definition of groups (sets of users) *within* a security descriptor. E.g., ...

{{{
<atombeat:security-descriptor>
    <atombeat:groups>
        <atombeat:group id="readers">
            <atombeat:member>richard</atombeat:member>
            <atombeat:member>rebecca</atombeat:member>
        </atombeat:group>
        <atombeat:group id="authors">
            <atombeat:member>alice</atombeat:member>
            <atombeat:member>austin</atombeat:member>
        </atombeat:group>
        <atombeat:group id="editors">
            <atombeat:member>emma</atombeat:member>
            <atombeat:member>edward</atombeat:member>
        </atombeat:group>
    </atombeat:groups>
    <atombeat:acl>
        <atombeat:ace>
            <atombeat:type>ALLOW</atombeat:type>
            <atombeat:recipient type="group">readers</atombeat:recipient>
            <atombeat:permission>RETRIEVE_MEMBER</atombeat:permission>
        </atombeat:ace>
        <atombeat:ace>
            <atombeat:type>ALLOW</atombeat:type>
            <atombeat:recipient type="group">authors</atombeat:recipient>
            <atombeat:permission>CREATE_MEMBER</atombeat:permission>
        </atombeat:ace>
        <atombeat:ace>
            <atombeat:type>ALLOW</atombeat:type>
            <atombeat:recipient type="group">editors</atombeat:recipient>
            <atombeat:permission>UPDATE_MEMBER</atombeat:permission>
        </atombeat:ace>
    </atombeat:acl>
</atombeat:security-descriptor>
}}}

This is primarily for convenience, to avoiding having to add many similar ACEs for users that all should have the same permissions. AtomBeat *does not* have a notion of global groups.

Note also that groups defined in one security descriptor can be referenced from another security descriptor. The URL used in the `@src` attribute is the URL of the workspace, collection, member or media resource who's security descriptor you want to reference. E.g., ...

{{{
<atombeat:security-descriptor>
    <atombeat:groups>
        <atombeat:group id="readers" src="http://localhost:8081/atombeat/atombeat/content/foo"/>
        <atombeat:group id="authors" src="http://localhost:8081/atombeat/atombeat/content/foo"/>
        <atombeat:group id="editors" src="http://localhost:8081/atombeat/atombeat/content/foo"/>
    </atombeat:groups>
    <atombeat:acl>
        <atombeat:ace>
            <atombeat:type>ALLOW</atombeat:type>
            <atombeat:recipient type="group">readers</atombeat:recipient>
            <atombeat:permission>RETRIEVE_MEMBER</atombeat:permission>
        </atombeat:ace>
        <atombeat:ace>
            <atombeat:type>ALLOW</atombeat:type>
            <atombeat:recipient type="group">authors</atombeat:recipient>
            <atombeat:permission>CREATE_MEMBER</atombeat:permission>
        </atombeat:ace>
        <atombeat:ace>
            <atombeat:type>ALLOW</atombeat:type>
            <atombeat:recipient type="group">editors</atombeat:recipient>
            <atombeat:permission>UPDATE_MEMBER</atombeat:permission>
        </atombeat:ace>
    </atombeat:acl>
</atombeat:security-descriptor>
}}}

If the source URL is not within the same AtomBeat instance, the group is ignored.

== Deleting Media Resources ==

The DELETE_MEDIA operation poses a problem because deleting a media-link entry is a side-effect of deleting a media resource, and vice versa. So what do you do if you want to have a mixed collection with some plain Atom members, and some media resources, and you want to allow deletion of plain members, but not of media resources? AtomBeat works around this by treating a deletion of a media-link entry as a DELETE_MEDIA operation, and *not* as a DELETE_MEMBER operation. This is just something to bear in mind when defining access control lists.

== AtomBeat ACLs vs. eXist Permissions ==

Note also that, although this security system is more expressive than the native eXist model of permissions, *it is not integrated with the eXist XQuery engine*. I.e., if you access the XML content you create using AtomBeat via some other means, e.g., via the eXist REST servlet, or via a custom XQuery, *you can completely bypass the AtomBeat access control system*.


